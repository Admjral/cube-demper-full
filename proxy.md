–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ø—Ä–æ–∫—Å–∏

1Ô∏è‚É£ –î–µ–º–ø–µ—Ä (70 –ø—Ä–æ–∫—Å–∏) - –ë–ï–ó–û–ü–ê–°–ù–û –¥–ª—è 24/7:

500 —Ç–æ–≤–∞—Ä–æ–≤ √ó 2 –∑–∞–ø—Ä–æ—Å–∞ (parse + sync) = 1000 –∑–∞–ø—Ä–æ—Å–æ–≤/—Ü–∏–∫–ª
1000 / 249 = 5 –ø—Ä–æ–∫—Å–∏ –Ω–∞ —Ü–∏–∫–ª (–Ω–µ 3!)
70 / 5 = 14 —Ü–∏–∫–ª–æ–≤
14 √ó 3 –º–∏–Ω—É—Ç—ã = 42 –º–∏–Ω—É—Ç—ã –æ—Ç–¥—ã—Ö–∞ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–∫—Å–∏

‚úÖ 42 –º–∏–Ω > 40 –º–∏–Ω (–º–∏–Ω–∏–º—É–º) ‚Üí –ë–ï–ó–û–ü–ê–°–ù–û!
2Ô∏è‚É£ –ú–æ–∏ –ø—Ä–æ–¥–∞–∂–∏ (25 –ø—Ä–æ–∫—Å–∏) - –ö–†–ò–¢–ò–ß–ù–û —É–≤–µ–ª–∏—á–∏–ª!
–í—ã –ø—Ä–∞–≤—ã - 15 –±—ã–ª–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è 200-500 –∑–∞–∫–∞–∑–æ–≤!


Worst case: 500 –∑–∞–∫–∞–∑–æ–≤ √ó 2 –∑–∞–ø—Ä–æ—Å–∞ = 1000 –∑–∞–ø—Ä–æ—Å–æ–≤
1000 / 249 = 5 –ø—Ä–æ–∫—Å–∏ –Ω–∞ —Ü–∏–∫–ª
25 / 5 = 5 —Ü–∏–∫–ª–æ–≤
5 √ó 10 –º–∏–Ω—É—Ç = 50 –º–∏–Ω—É—Ç –æ—Ç–¥—ã—Ö–∞

‚úÖ 50 –º–∏–Ω > 40 –º–∏–Ω ‚Üí –ë–ï–ó–û–ü–ê–°–ù–û!
‚úÖ –¢–µ–ø–µ—Ä—å –¥–∞–∂–µ –±–æ–ª—å—à–∏–µ –º–∞–≥–∞–∑–∏–Ω—ã –Ω–µ –ø–æ–ª—É—á–∞—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É!
3Ô∏è‚É£ –ù–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞:

–î–µ–º–ø–µ—Ä:   70 –ø—Ä–æ–∫—Å–∏ (1000 req/3 –º–∏–Ω)   ‚Üê –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
Orders:   25 –ø—Ä–æ–∫—Å–∏ (–¥–æ 1000 req/10–º–∏–Ω) ‚Üê —É–≤–µ–ª–∏—á–∏–ª —Å 15!
Catalog:   5 –ø—Ä–æ–∫—Å–∏ (20 req —Ä–µ–¥–∫–æ)     ‚Üê —É–º–µ–Ω—å—à–∏–ª —Å 10
Reserve:   0 –ø—Ä–æ–∫—Å–∏                     ‚Üê —É–±—Ä–∞–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º catalog

–ò–¢–û–ì–û: 100 –ø—Ä–æ–∫—Å–∏ = $11/–º–µ—Å—è—Ü ‚úÖ
üöÄ –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å –ë–ï–ó –û–ß–ï–†–ï–î–ï–ô:

–î–µ–º–ø–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–æ–∫—Å–∏ 1-70
  ‚îî‚îÄ 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã

Orders —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–æ–∫—Å–∏ 71-95  ‚Üê –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û!
  ‚îî‚îÄ –¥–æ 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç

Catalog —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–æ–∫—Å–∏ 96-100
  ‚îî‚îÄ ~20 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é

‚ùå –ë–ï–ó —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è: Orders –∂–¥–µ—Ç –ø–æ–∫–∞ –î–µ–º–ø–µ—Ä –æ—Å–≤–æ–±–æ–¥–∏—Ç –ø—Ä–æ–∫—Å–∏
‚úÖ –° —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º: Orders –∏–º–µ–µ—Ç —Å–≤–æ–∏ 25 –ø—Ä–æ–∫—Å–∏, –Ω–µ –∂–¥–µ—Ç –Ω–∏–∫–æ–≥–æ!
–ü–ª–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω —Å:

‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–π –º–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π –æ—Ç–¥—ã—Ö–∞ (42 –º–∏–Ω –¥–ª—è –¥–µ–º–ø–µ—Ä–∞, 50 –º–∏–Ω –¥–ª—è orders)
‚úÖ 25 –ø—Ä–æ–∫—Å–∏ –¥–ª—è orders (–≤–º–µ—Å—Ç–æ 15) –¥–ª—è –±–æ–ª—å—à–∏—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤
‚úÖ Per-module –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –≤–æ –≤—Å–µ—Ö –≤–æ—Ä–∫–µ—Ä–∞—Ö
‚úÖ ORDERS_POLLING_INTERVAL = 600 —Å–µ–∫ (10 –º–∏–Ω—É—Ç)
‚úÖ –¢–µ—Å—Ç–∞–º–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –º–æ–¥—É–ª–µ–π
Claude‚Äôs Plan
–ü–ª–∞–Ω: Per-User Proxy Pool –¥–ª—è –æ–±—Ö–æ–¥–∞ Kaspi API –ª–∏–º–∏—Ç–æ–≤
–ü—Ä–æ–±–ª–µ–º–∞
–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ Kaspi API:

–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã:
Kaspi –ª–∏–º–∏—Ç: 250 –∑–∞–ø—Ä–æ—Å–æ–≤ / 30 –º–∏–Ω—É—Ç = 8.33 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É (0.139 RPS)
–¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ:
500 —Ç–æ–≤–∞—Ä–æ–≤ √ó 2 –∑–∞–ø—Ä–æ—Å–∞ (parse + sync) = 1000 –∑–∞–ø—Ä–æ—Å–æ–≤
–î–µ–º–ø–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã = 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ / 3 –º–∏–Ω = 333 –∑–∞–ø—Ä–æ—Å–∞/–º–∏–Ω—É—Ç—É
–ü–ª—é—Å: –ø—Ä–µ–¥–∑–∞–∫–∞–∑—ã, –ø—Ä–æ–¥–∞–∂–∏, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è = –µ—â–µ ~50 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
–ò–¢–û–ì–û: ~383 –∑–∞–ø—Ä–æ—Å–∞/–º–∏–Ω—É—Ç—É
–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞:

383 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω / 8.33 –ª–∏–º–∏—Ç = 46x –ü–†–ï–í–´–®–ï–ù–ò–ï! üî¥
–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:

Kaspi –±–∞–Ω–∏—Ç –∞–∫–∫–∞—É–Ω—Ç (429 Too Many Requests)
–î–µ–º–ø–∏–Ω–≥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
–ü—Ä–µ–¥–∑–∞–∫–∞–∑—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
Circuit breaker –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è ‚Üí –≤–µ—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–∞–¥–∞–µ—Ç
–†–µ—à–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–ê–ª–≥–∞—Ç–æ–ø, –î–µ–º–µ—Ç—Ä–∞)
–û–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–æ–∫—Å–∏-—Ä–æ—Ç–∞—Ü–∏—é:

‚úÖ –î–µ–º–ø–∏–Ω–≥ –í–°–ï–• —Ç–æ–≤–∞—Ä–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (–Ω–µ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ)
‚úÖ –†–æ—Ç–∞—Ü–∏—è –ø—Ä–æ–∫—Å–∏ –∫–∞–∂–¥—ã–µ 250 –∑–∞–ø—Ä–æ—Å–æ–≤
‚úÖ –ü—Ä–æ–∫—Å–∏ "–æ—Ç–¥—ã—Ö–∞—é—Ç" 40 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
‚úÖ –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ö–æ–¥–∏—Ç—å rate limiting Kaspi
–ù–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ: –ï—â–µ –ª—É—á—à–µ - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—É–ª –ø—Ä–æ–∫—Å–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —é–∑–µ—Ä–∞!

–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
Rate Limiter: new-backend/app/core/rate_limiter.py

–¢–µ–∫—É—â–∏–π: 60 RPS –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç (–¥–ª—è –í–°–ï–• –∑–∞–ø—Ä–æ—Å–æ–≤, –Ω–µ —Ç–æ–ª—å–∫–æ Kaspi)
–ü—Ä–æ–±–ª–µ–º–∞: –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ª–∏–º–∏—Ç 250/30min –¥–ª—è Kaspi
–î–µ–º–ø–∏–Ω–≥ Worker: new-backend/app/workers/demper_instance.py

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 500 —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ —Ü–∏–∫–ª
2 –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Ç–æ–≤–∞—Ä: parse_product_by_sku + sync_product
–ù–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏, –Ω–µ—Ç –±–∞—Ç—á–∏–Ω–≥–∞
API Parser: new-backend/app/services/api_parser.py

parse_product_by_sku() (—Å—Ç—Ä–æ–∫–∞ 341) - —á–∏—Ç–∞–µ—Ç —Ü–µ–Ω—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
sync_product() (—Å—Ç—Ä–æ–∫–∞ 459) - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—É
–ù–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–µ—Ç –±–∞—Ç—á–∏–Ω–≥–∞
Config: new-backend/app/config.py

global_rps: int = 60 (—Å—Ç—Ä–æ–∫–∞ 77)
–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è: Per-User Proxy Pool
–ö–æ–Ω—Ü–µ–ø—Ü–∏—è
–ö–∞–∂–¥–æ–º—É –ø–ª–∞—Ç–Ω–æ–º—É —é–∑–µ—Ä—É = 100 –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø–æ –º–æ–¥—É–ª—è–º


‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  User –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É (Premium)                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–¥–µ–ª—è–µ–º 100 –ø—Ä–æ–∫—Å–∏ –∏–∑ –ø—É–ª–∞          ‚îÇ
‚îÇ  proxies.user_id = user.id                          ‚îÇ
‚îÇ  proxies.status = 'allocated'                       ‚îÇ
‚îÇ  proxies.module = 'demper' | 'orders' | 'catalog' | 'reserve' ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –†–ê–ó–î–ï–õ–ï–ù–ò–ï –ü–û –ú–û–î–£–õ–Ø–ú (per-module pools):          ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ 70 –ø—Ä–æ–∫—Å–∏ ‚Üí –î–µ–º–ø–µ—Ä (demper_instance.py)        ‚îÇ
‚îÇ  ‚îÇ   - –†–æ—Ç–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 249 –∑–∞–ø—Ä–æ—Å–æ–≤                 ‚îÇ
‚îÇ  ‚îÇ   - 1000 –∑–∞–ø—Ä–æ—Å–æ–≤/—Ü–∏–∫–ª (500 —Ç–æ–≤–∞—Ä–æ–≤ √ó 2)        ‚îÇ
‚îÇ  ‚îÇ   - 5 –ø—Ä–æ–∫—Å–∏ –Ω–∞ —Ü–∏–∫–ª, 14 —Ü–∏–∫–ª–æ–≤ = 42 –º–∏–Ω –æ—Ç–¥—ã—Ö–∞ ‚îÇ
‚îÇ  ‚îÇ   - 24/7 —Ä–∞–±–æ—Ç–∞ –ë–ï–ó–û–ü–ê–°–ù–ê ‚úÖ (42 > 40 –º–∏–Ω)      ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ 25 –ø—Ä–æ–∫—Å–∏ ‚Üí –ú–æ–∏ –ø—Ä–æ–¥–∞–∂–∏ (orders_worker.py)     ‚îÇ
‚îÇ  ‚îÇ   - –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç                             ‚îÇ
‚îÇ  ‚îÇ   - 200-500 –∑–∞–∫–∞–∑–æ–≤ = –¥–æ 1000 –∑–∞–ø—Ä–æ—Å–æ–≤! üî•      ‚îÇ
‚îÇ  ‚îÇ   - 5 –ø—Ä–æ–∫—Å–∏ –Ω–∞ —Ü–∏–∫–ª, 5 —Ü–∏–∫–ª–æ–≤ = 50 –º–∏–Ω –æ—Ç–¥—ã—Ö–∞  ‚îÇ
‚îÇ  ‚îÇ   - –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤! ‚úÖ          ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ 5 –ø—Ä–æ–∫—Å–∏ ‚Üí –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞              ‚îÇ
‚îÇ  ‚îÇ   - –ü–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–µ–¥–∫–æ)             ‚îÇ
‚îÇ  ‚îÇ   - ~20 –∑–∞–ø—Ä–æ—Å–æ–≤ = 1 –ø—Ä–æ–∫—Å–∏                     ‚îÇ
‚îÇ  ‚îÇ   - 5 –ø—Ä–æ–∫—Å–∏ = –∑–∞–ø–∞—Å –Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å–∏–Ω—Ö—Ä.     ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ
‚îÇ  ‚îî‚îÄ 0 –ø—Ä–æ–∫—Å–∏ ‚Üí –†–µ–∑–µ—Ä–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º catalog –ø—Ä–æ–∫—Å–∏)  ‚îÇ
‚îÇ      - –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –±–µ—Ä–µ–º –∏–∑ catalog –ø—É–ª–∞     ‚îÇ
‚îÇ      - –≠–∫–æ–Ω–æ–º–∏–º –º–µ—Å—Ç–æ –¥–ª—è –≤–∞–∂–Ω—ã—Ö –º–æ–¥—É–ª–µ–π           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úÖ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê:                                   ‚îÇ
‚îÇ  - –ù–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏                  ‚îÇ
‚îÇ  - –î–µ–º–ø–µ—Ä + orders —Ä–∞–±–æ—Ç–∞—é—Ç –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û            ‚îÇ
‚îÇ  - 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏      ‚îÇ
‚îÇ  - –ò–∑–æ–ª—è—Ü–∏—è: –µ—Å–ª–∏ orders –ø—Ä–æ–∫—Å–∏ —É–º–µ—Ä, –¥–µ–º–ø–µ—Ä OK    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
–î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –º–æ–¥—É–ª—è–º:
1Ô∏è‚É£ –î–µ–º–ø–µ—Ä (demper_instance.py)
–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:

GET https://kaspi.kz/yml/offer-view/offers/{product_id} - —Ü–µ–Ω—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
POST https://mc.shop.kaspi.kz/pricefeed/upload/merchant/process - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã
–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –¥–ª—è 500 —Ç–æ–≤–∞—Ä–æ–≤:

–§–∞–∑–∞ 1: parse_product_by_sku ‚Üí 500 –∑–∞–ø—Ä–æ—Å–æ–≤
–§–∞–∑–∞ 2: sync_product (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã) ‚Üí 500 –∑–∞–ø—Ä–æ—Å–æ–≤
–ò–¢–û–ì–û: ~1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ü–∏–∫–ª (–∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã)
–° 70 –ø—Ä–æ–∫—Å–∏:

1000 / 249 = 4.02 ‚Üí 5 –ø—Ä–æ–∫—Å–∏ –Ω–∞ —Ü–∏–∫–ª
70 / 5 = 14 —Ü–∏–∫–ª–æ–≤ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–∞
14 √ó 3 –º–∏–Ω—É—Ç—ã = 42 –º–∏–Ω—É—Ç—ã –æ—Ç–¥—ã—Ö–∞ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–∫—Å–∏
‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û –¥–ª—è 24/7: 42 –º–∏–Ω > 40 –º–∏–Ω (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç–¥—ã—Ö)
2Ô∏è‚É£ –ú–æ–∏ –ø—Ä–æ–¥–∞–∂–∏ (orders_worker.py)
–≠–Ω–¥–ø–æ–∏–Ω—Ç:

GET https://kaspi.kz/shop/api/v2/orders - —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ (WORST CASE - –±–æ–ª—å—à–æ–π –º–∞–≥–∞–∑–∏–Ω):

–ù–∞ 1 –º–∞–≥–∞–∑–∏–Ω: 200-500 –∑–∞–∫–∞–∑–æ–≤ (–ø–æ –¥–∞–Ω–Ω—ã–º —é–∑–µ—Ä–∞!)
–ö–∞–∂–¥—ã–π –∑–∞–∫–∞–∑: ~2 –∑–∞–ø—Ä–æ—Å–∞ (fetch + details —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)
Worst case: 500 –∑–∞–∫–∞–∑–æ–≤ √ó 2 = 1000 –∑–∞–ø—Ä–æ—Å–æ–≤
–ò–Ω—Ç–µ—Ä–≤–∞–ª: –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ ORDERS_POLLING_INTERVAL)
–° 25 –ø—Ä–æ–∫—Å–∏:

1000 / 249 = 4.02 ‚Üí 5 –ø—Ä–æ–∫—Å–∏ –Ω–∞ —Ü–∏–∫–ª
25 / 5 = 5 —Ü–∏–∫–ª–æ–≤ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–∞
5 √ó 10 –º–∏–Ω—É—Ç = 50 –º–∏–Ω—É—Ç –æ—Ç–¥—ã—Ö–∞ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–∫—Å–∏
‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û: 50 –º–∏–Ω > 40 –º–∏–Ω (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç–¥—ã—Ö)
‚úÖ –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤! (–±–µ–∑ –ø—Ä–æ–∫—Å–∏ = –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
3Ô∏è‚É£ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ (kaspi.py ‚Üí get_products)
–≠–Ω–¥–ø–æ–∏–Ω—Ç:

GET https://mc.shop.kaspi.kz/bff/offer-view/list - —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞:

–ù–∞ –º–∞–≥–∞–∑–∏–Ω —Å 1000 —Ç–æ–≤–∞—Ä–æ–≤: ~10-20 –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–∞–≥–∏–Ω–∞—Ü–∏—è –ø–æ 50-100)
–í—ã–∑—ã–≤–∞–µ—Ç—Å—è: –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–Ω–æ–ø–∫–∞ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å")
–ò–¢–û–ì–û: ~20 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —Ä–∞–∑, —Ä–µ–¥–∫–æ (1-2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å)
–° 5 –ø—Ä–æ–∫—Å–∏:

20 / 249 = 0.08 ‚Üí 1 –ø—Ä–æ–∫—Å–∏ —Ö–≤–∞—Ç–∏—Ç
5 –ø—Ä–æ–∫—Å–∏ = –º–æ–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ 5 –º–∞–≥–∞–∑–∏–Ω–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ! (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)
–ò–¢–û–ì–û –∑–∞ –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –¥–µ–º–ø–∏–Ω–≥–∞ (3 –º–∏–Ω—É—Ç—ã):

–î–µ–º–ø–µ—Ä:                    1000 –∑–∞–ø—Ä–æ—Å–æ–≤ (70 –ø—Ä–æ–∫—Å–∏, 5 –∞–∫—Ç–∏–≤–Ω—ã—Ö)
Orders (–µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç):   –¥–æ 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ (25 –ø—Ä–æ–∫—Å–∏, 5 –∞–∫—Ç–∏–≤–Ω—ã—Ö) üî•
–ö–∞—Ç–∞–ª–æ–≥ (–µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏):     ~20 –∑–∞–ø—Ä–æ—Å–æ–≤ (5 –ø—Ä–æ–∫—Å–∏, 1 –∞–∫—Ç–∏–≤–Ω—ã–π)

–û–î–ù–û–í–†–ï–ú–ï–ù–ù–û:              –¥–æ 2020 –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –†–ê–ó–ù–´–• –ø—Ä–æ–∫—Å–∏!
                           Kaspi –≤–∏–¥–∏—Ç —ç—Ç–æ –∫–∞–∫ —Ç—Ä–∞—Ñ–∏–∫ –æ—Ç 100 —Ä–∞–∑–Ω—ã—Ö —é–∑–µ—Ä–æ–≤ ‚úÖ
                           –ù–ï–¢ –ë–õ–û–ö–ò–†–û–í–û–ö, –ù–ï–¢ –û–ß–ï–†–ï–î–ï–ô! üöÄ
–ü–æ—á–µ–º—É 100 –ø—Ä–æ–∫—Å–∏ —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞ 24/7:

–î–µ–º–ø–µ—Ä: 70 –ø—Ä–æ–∫—Å–∏, 5 –∑–∞ —Ü–∏–∫–ª, 14 —Ü–∏–∫–ª–æ–≤ √ó 3 –º–∏–Ω = 42 –º–∏–Ω –æ—Ç–¥—ã—Ö–∞ ‚úÖ
Orders: 25 –ø—Ä–æ–∫—Å–∏, 5 –∑–∞ —Ü–∏–∫–ª, 5 —Ü–∏–∫–ª–æ–≤ √ó 10 –º–∏–Ω = 50 –º–∏–Ω –æ—Ç–¥—ã—Ö–∞ ‚úÖ
Catalog: 5 –ø—Ä–æ–∫—Å–∏, —Ä–µ–¥–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ, –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã ‚úÖ
–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ per-module pools:


–ë–ï–ó —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (—Å—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥):
  –î–µ–º–ø–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–∫—Å–∏ 1-5 ‚Üí Orders –∂–¥–µ—Ç ‚Üí –û–ß–ï–†–ï–î–¨! ‚ùå

–° —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º (–Ω–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥):
  –î–µ–º–ø–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–∫—Å–∏ 1-70
  Orders –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–∫—Å–∏ 71-95   ‚Üê –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û! ‚úÖ
  Catalog –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–∫—Å–∏ 96-100
–ü–µ—Ä–≤—ã–µ –ø—Ä–æ–∫—Å–∏ "–æ—Ç–¥—ã—Ö–∞—é—Ç" 48 –º–∏–Ω—É—Ç ‚Üí –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è ‚úÖ
–î–∞–∂–µ –ø—Ä–∏ 1000 —Ç–æ–≤–∞—Ä–æ–≤:

1000 √ó 2 / 249 = 8 –ø—Ä–æ–∫—Å–∏ –Ω–∞ —Ü–∏–∫–ª
100 / 8 = 12 —Ü–∏–∫–ª–æ–≤ = 36 –º–∏–Ω—É—Ç ‚Üí –ø—Ä–æ–∫—Å–∏ –≤—Å–µ –µ—â–µ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è ‚úÖ
–†–µ—à–µ–Ω–∏–µ: Per-User Proxy Pool Architecture
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:
Proxy Provider Integration - –∑–∞–∫—É–ø–∫–∞ –ø—Ä–æ–∫—Å–∏
Proxy Pool Manager - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—É–ª–æ–º –ø—Ä–æ–∫—Å–∏
User Proxy Allocator - –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ —é–∑–µ—Ä–∞–º
Proxy Rotator - —Ä–æ—Ç–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 249 –∑–∞–ø—Ä–æ—Å–æ–≤
Billing Integration - –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
–°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: Database Schema (P0 - –ö—Ä–∏—Ç–∏—á–Ω–æ)
–¶–µ–ª—å: –•—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–∫—Å–∏, –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∫ —é–∑–µ—Ä–∞–º, —Ç—Ä–µ–∫–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

SQL Schema:


-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–∫—Å–∏
CREATE TABLE proxies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Proxy connection details
    host VARCHAR(255) NOT NULL,
    port INTEGER NOT NULL,
    protocol VARCHAR(10) DEFAULT 'http',  -- http, socks5
    username VARCHAR(255),
    password VARCHAR(255),

    -- User allocation
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    allocated_at TIMESTAMP,  -- –ö–æ–≥–¥–∞ –≤—ã–¥–µ–ª–µ–Ω —é–∑–µ—Ä—É
    status VARCHAR(20) DEFAULT 'available',  -- available, allocated, resting, dead

    -- ‚ú® NEW: Module assignment (per-module proxy pools)
    module VARCHAR(20) DEFAULT NULL,  -- 'demper', 'orders', 'catalog', 'reserve', NULL
    -- NULL = –Ω–µ –≤—ã–¥–µ–ª–µ–Ω –Ω–∏–∫–∞–∫–æ–º—É –º–æ–¥—É–ª—é (available –≤ –æ–±—â–µ–º –ø—É–ª–µ)

    -- Rotation tracking (–≤ –ø–∞–º—è—Ç–∏ worker'–∞, –Ω–æ backup –≤ –ë–î)
    requests_count INTEGER DEFAULT 0,
    max_requests INTEGER DEFAULT 249,  -- ‚ö†Ô∏è 249, –Ω–µ 250!
    last_used_at TIMESTAMP,
    available_at TIMESTAMP,  -- –ö–æ–≥–¥–∞ —Å–Ω–æ–≤–∞ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (–ø–æ—Å–ª–µ resting)

    -- Health monitoring
    success_count INTEGER DEFAULT 0,
    failure_count INTEGER DEFAULT 0,
    last_error TEXT,
    last_health_check TIMESTAMP,

    -- Metadata
    country VARCHAR(10) DEFAULT 'NL',  -- Netherlands IPv6
    provider VARCHAR(50),
    cost_usd DECIMAL(10,4),  -- –î–ª—è –±–∏–ª–ª–∏–Ω–≥–∞
    is_residential BOOLEAN DEFAULT FALSE,

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_proxies_user_status (user_id, status, available_at),
    INDEX idx_proxies_user_module (user_id, module, status, available_at),  -- ‚ú® NEW: –¥–ª—è –º–æ–¥—É–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    INDEX idx_proxies_available (status, user_id) WHERE status = 'available',
    UNIQUE (host, port)
);

-- –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
CREATE TABLE proxy_usage_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    proxy_id UUID REFERENCES proxies(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,

    requests_made INTEGER,
    success_count INTEGER,
    failure_count INTEGER,

    started_at TIMESTAMP,
    finished_at TIMESTAMP,

    INDEX idx_usage_proxy_time (proxy_id, started_at DESC),
    INDEX idx_usage_user_time (user_id, started_at DESC)
);
–ú–∏–≥—Ä–∞—Ü–∏—è:

–°–æ–∑–¥–∞—Ç—å: new-backend/migrations/versions/20260131_add_proxy_pool.py
–°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: Proxy Allocator - –í—ã–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã (P0 - –ö—Ä–∏—Ç–∏—á–Ω–æ)
–¶–µ–ª—å: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–¥–µ–ª–∏—Ç—å 100 –ø—Ä–æ–∫—Å–∏ —é–∑–µ—Ä—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏

–õ–æ–≥–∏–∫–∞:


# new-backend/app/services/proxy_allocator.py

class ProxyAllocator:
    """–í—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ —é–∑–µ—Ä–∞–º –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã"""

    async def allocate_proxies_to_user(
        self,
        user_id: UUID,
        count: int = 100,
        distribution: dict = None  # ‚ú® NEW: —Ä–∞–∑–±–∏–≤–∫–∞ –ø–æ –º–æ–¥—É–ª—è–º
    ) -> Dict[str, List[Proxy]]:
        """
        –í—ã–¥–µ–ª–∏—Ç—å N –ø—Ä–æ–∫—Å–∏ —é–∑–µ—Ä—É –∏–∑ available –ø—É–ª–∞ —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ –º–æ–¥—É–ª—è–º

        –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:
        - 70 –ø—Ä–æ–∫—Å–∏ ‚Üí –¥–µ–º–ø–µ—Ä
        - 15 –ø—Ä–æ–∫—Å–∏ ‚Üí orders
        - 10 –ø—Ä–æ–∫—Å–∏ ‚Üí catalog
        - 5 –ø—Ä–æ–∫—Å–∏ ‚Üí reserve

        Steps:
        1. –ù–∞–π—Ç–∏ available –ø—Ä–æ–∫—Å–∏ (status='available', user_id IS NULL)
        2. –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Üí –∑–∞–∫—É–ø–∏—Ç—å –Ω–æ–≤—ã–µ (—Å–º. proxy_provider)
        3. –ü—Ä–∏—Å–≤–æ–∏—Ç—å —é–∑–µ—Ä—É —Å —É–∫–∞–∑–∞–Ω–∏–µ–º module
        4. –ó–∞–ø–∏—Å–∞—Ç—å –≤ –ª–æ–≥
        """

        if distribution is None:
            distribution = {
                'demper': 70,    # –û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (500 —Ç–æ–≤–∞—Ä–æ–≤ √ó 2 = 1000 req)
                'orders': 25,    # –ú–æ–∏ –ø—Ä–æ–¥–∞–∂–∏ (200-500 –∑–∞–∫–∞–∑–æ–≤ = –¥–æ 1000 req!)
                'catalog': 5,    # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ (—Ä–µ–¥–∫–æ)
                'reserve': 0     # –†–µ–∑–µ—Ä–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º catalog –ø—Ä–æ–∫—Å–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
            }

        total_needed = sum(distribution.values())
        if total_needed != count:
            raise ValueError(f"Distribution sum {total_needed} != requested {count}")

        result = {}
        async with pool.acquire() as conn:
            for module, module_count in distribution.items():
                # –í–∑—è—Ç—å N –ø—Ä–æ–∫—Å–∏ –¥–ª—è –º–æ–¥—É–ª—è
                query = """
                    UPDATE proxies
                    SET user_id = $1,
                        status = 'allocated',
                        module = $2,
                        allocated_at = NOW()
                    WHERE id IN (
                        SELECT id FROM proxies
                        WHERE status = 'available'
                          AND user_id IS NULL
                        ORDER BY created_at ASC
                        LIMIT $3
                        FOR UPDATE SKIP LOCKED
                    )
                    RETURNING *
                """
                proxies = await conn.fetch(query, user_id, module, module_count)

                if len(proxies) < module_count:
                    # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ–∫—Å–∏ –≤ –ø—É–ª–µ ‚Üí –Ω—É–∂–Ω–æ –∑–∞–∫—É–ø–∏—Ç—å
                    shortage = module_count - len(proxies)
                    logger.warning(f"Proxy pool shortage for {module}: {shortage} proxies needed")

                    # TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Proxy Provider API
                    # await proxy_provider.purchase_proxies(shortage)

                    raise InsufficientProxiesError(
                        f"Only {len(proxies)}/{module_count} proxies available for {module}"
                    )

                result[module] = [Proxy(**p) for p in proxies]
                logger.info(f"Allocated {len(proxies)} proxies to user {user_id} for module {module}")

            return result

    async def deallocate_proxies_from_user(self, user_id: UUID):
        """
        –û—Å–≤–æ–±–æ–¥–∏—Ç—å –≤—Å–µ –ø—Ä–æ–∫—Å–∏ —é–∑–µ—Ä–∞ (–∫–æ–≥–¥–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∫–æ–Ω—á–∏–ª–∞—Å—å)
        """
        query = """
            UPDATE proxies
            SET user_id = NULL,
                status = 'available',
                allocated_at = NULL,
                requests_count = 0,
                available_at = NULL
            WHERE user_id = $1
            RETURNING COUNT(*)
        """
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∏–ª–ª–∏–Ω–≥–æ–º:


# new-backend/app/routers/billing.py

@router.post("/subscribe")
async def subscribe_user(
    plan: SubscriptionPlan,
    current_user: dict = Depends(get_current_user),
    pool: asyncpg.Pool = Depends(get_db_pool)
):
    # ... payment processing ...

    if payment_successful:
        # –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
        subscription = await create_subscription(user_id, plan)

        # ‚úÖ –í–´–î–ï–õ–ò–¢–¨ –ü–†–û–ö–°–ò –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò
        if plan in ['premium', 'ultra']:  # –¢–æ–ª—å–∫–æ –ø–ª–∞—Ç–Ω—ã–µ –ø–ª–∞–Ω—ã
            try:
                proxies = await proxy_allocator.allocate_proxies_to_user(
                    user_id=current_user['id'],
                    count=100
                )
                logger.info(f"Allocated {len(proxies)} proxies to user {current_user['id']}")
            except InsufficientProxiesError as e:
                logger.error(f"Failed to allocate proxies: {e}")
                # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç –∞–¥–º–∏–Ω—É
                await send_admin_alert(f"Proxy pool depleted! User {current_user['id']}")

        return {"subscription": subscription, "proxies_allocated": len(proxies)}
Webhook –¥–ª—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:


# new-backend/app/workers/subscription_cleanup.py

async def cleanup_expired_subscriptions():
    """
    –ö—Ä–æ–Ω-–¥–∂–æ–±–∞: –∫–∞–∂–¥—ã–µ 1 —á–∞—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
    –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –∏—Ö –ø—Ä–æ–∫—Å–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø—É–ª
    """
    query = """
        SELECT user_id FROM subscriptions
        WHERE status = 'active'
          AND current_period_end < NOW()
    """

    expired_users = await conn.fetch(query)

    for user in expired_users:
        # –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
        await deactivate_subscription(user['user_id'])

        # –û—Å–≤–æ–±–æ–¥–∏—Ç—å –ø—Ä–æ–∫—Å–∏
        await proxy_allocator.deallocate_proxies_from_user(user['user_id'])

        logger.info(f"Freed proxies from expired user {user['user_id']}")
–§–∞–π–ª—ã:

–°–æ–∑–¥–∞—Ç—å: new-backend/app/services/proxy_allocator.py (~200 —Å—Ç—Ä–æ–∫)
–ò–∑–º–µ–Ω–∏—Ç—å: new-backend/app/routers/billing.py (–¥–æ–±–∞–≤–∏—Ç—å allocate –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã)
–°–æ–∑–¥–∞—Ç—å: new-backend/app/workers/subscription_cleanup.py (~100 —Å—Ç—Ä–æ–∫)
–°—Ç—Ä–∞—Ç–µ–≥–∏—è 3: Proxy Rotator - –†–æ—Ç–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 249 –∑–∞–ø—Ä–æ—Å–æ–≤ (P0 - –ö—Ä–∏—Ç–∏—á–Ω–æ)
–¶–µ–ª—å: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–µ–Ω—è—Ç—å –ø—Ä–æ–∫—Å–∏ –ø–æ—Å–ª–µ 249 –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–µ 250!)

–ö–ª—é—á–µ–≤–∞—è –ª–æ–≥–∏–∫–∞:


# new-backend/app/core/proxy_rotator.py

class ProxyRotator:
    """
    –£–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–æ—Ç–∞—Ü–∏–µ–π –ø—Ä–æ–∫—Å–∏ –¥–ª—è —é–∑–µ—Ä–∞

    –õ–æ–≥–∏–∫–∞:
    - –ù–∞—á–∏–Ω–∞–µ—Ç —Å –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–∫—Å–∏
    - –¢—Ä–µ–∫–∞–µ—Ç requests_count –≤ –ø–∞–º—è—Ç–∏ (–±—ã—Å—Ç—Ä–æ!)
    - –ü–æ—Å–ª–µ 249 –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí –±–µ—Ä–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–æ–∫—Å–∏
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–∫—Å–∏ ‚Üí resting –Ω–∞ 40 –º–∏–Ω—É—Ç
    """

    def __init__(self, user_id: UUID, module: str = 'demper'):  # ‚ú® NEW: module –ø–∞—Ä–∞–º–µ—Ç—Ä
        self.user_id = user_id
        self.module = module  # ‚ú® NEW: 'demper', 'orders', 'catalog', 'reserve'
        self.current_proxy: Optional[Proxy] = None
        self.current_requests_count = 0
        self.max_requests_per_proxy = 249  # ‚ö†Ô∏è –ù–µ 250!

        # –ö–µ—à –ø—Ä–æ–∫—Å–∏ —é–∑–µ—Ä–∞ –≤ –ø–∞–º—è—Ç–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è!)
        self.user_proxies: List[Proxy] = []
        self.proxy_index = 0

    async def initialize(self):
        """
        –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–∫—Å–∏ —é–∑–µ—Ä–∞ –¥–ª—è –≠–¢–û–ì–û –ú–û–î–£–õ–Ø –∏–∑ –ë–î –≤ –ø–∞–º—è—Ç—å
        """
        query = """
            SELECT * FROM proxies
            WHERE user_id = $1
              AND module = $2
              AND status IN ('allocated', 'resting')
            ORDER BY
                CASE WHEN status = 'allocated' THEN 0 ELSE 1 END,
                available_at ASC NULLS FIRST,
                last_used_at ASC NULLS FIRST
        """
        proxies = await conn.fetch(query, self.user_id, self.module)
        self.user_proxies = [Proxy(**p) for p in proxies]

        if not self.user_proxies:
            raise NoProxiesAllocatedError(
                f"User {self.user_id} has no proxies for module '{self.module}'"
            )

        # –í–∑—è—Ç—å –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
        self.current_proxy = await self._get_next_available_proxy()

    async def _get_next_available_proxy(self) -> Proxy:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø—Ä–æ–∫—Å–∏

        –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
        1. status='allocated' (–µ—â–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è)
        2. status='resting' –Ω–æ available_at <= NOW() (–æ—Ç–¥–æ—Ö–Ω—É–ª)
        3. –ï—Å–ª–∏ –≤—Å–µ resting ‚Üí –≤–∑—è—Ç—å —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º available_at
        """
        now = datetime.now(timezone.utc)

        # –°–æ—Ä—Ç–∏—Ä—É–µ–º: allocated –ø–µ—Ä–≤—ã–º–∏, –ø–æ—Ç–æ–º resting –ø–æ available_at
        available = [
            p for p in self.user_proxies
            if p.status == 'allocated' or (
                p.status == 'resting' and
                (p.available_at is None or p.available_at <= now)
            )
        ]

        if available:
            return available[0]

        # –í—Å–µ –µ—â–µ resting ‚Üí –±–µ—Ä–µ–º –±–ª–∏–∂–∞–π—à–∏–π
        resting = [p for p in self.user_proxies if p.status == 'resting']
        if resting:
            # –ñ–¥–µ–º –¥–æ available_at –±–ª–∏–∂–∞–π—à–µ–≥–æ
            next_proxy = min(resting, key=lambda p: p.available_at or now)
            wait_seconds = (next_proxy.available_at - now).total_seconds()

            if wait_seconds > 0:
                logger.warning(
                    f"All proxies resting, waiting {wait_seconds:.1f}s "
                    f"for proxy {next_proxy.id}"
                )
                await asyncio.sleep(wait_seconds)

            return next_proxy

        raise NoProxiesAvailableError("All proxies are dead or unavailable")

    async def get_current_proxy(self) -> Proxy:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–∫—Å–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–æ—Ç–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ 249 –∑–∞–ø—Ä–æ—Å–æ–≤!
        """
        if self.current_requests_count >= self.max_requests_per_proxy:
            # –î–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ ‚Üí —Ä–æ—Ç–∞—Ü–∏—è
            await self._rotate_proxy()

        return self.current_proxy

    async def _rotate_proxy(self):
        """
        –°–º–µ–Ω–∏—Ç—å –ø—Ä–æ–∫—Å–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π

        1. –¢–µ–∫—É—â–∏–π –ø—Ä–æ–∫—Å–∏ ‚Üí resting (40 –º–∏–Ω—É—Ç)
        2. –í–∑—è—Ç—å —Å–ª–µ–¥—É—é—â–∏–π available
        3. –°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
        """
        if self.current_proxy:
            # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –æ—Ç–¥—ã—Ö
            await self._set_proxy_resting(
                self.current_proxy.id,
                duration_minutes=40
            )

            logger.info(
                f"Proxy {self.current_proxy.id} rotated after "
                f"{self.current_requests_count} requests (resting 40min)"
            )

        # –í–∑—è—Ç—å —Å–ª–µ–¥—É—é—â–∏–π
        self.current_proxy = await self._get_next_available_proxy()
        self.current_requests_count = 0

        logger.info(f"Switched to proxy {self.current_proxy.id}")

    async def _set_proxy_resting(self, proxy_id: UUID, duration_minutes: int):
        """
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–∫—Å–∏ –Ω–∞ –æ—Ç–¥—ã—Ö
        """
        query = """
            UPDATE proxies
            SET status = 'resting',
                available_at = NOW() + INTERVAL '%s minutes',
                requests_count = 0  -- –°–±—Ä–æ—Å –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            WHERE id = $1
        """
        await conn.execute(query % duration_minutes, proxy_id)

        # –û–±–Ω–æ–≤–∏—Ç—å –≤ –∫–µ—à–µ
        for p in self.user_proxies:
            if p.id == proxy_id:
                p.status = 'resting'
                p.available_at = datetime.now(timezone.utc) + timedelta(
                    minutes=duration_minutes
                )

    async def record_request(self, success: bool):
        """
        –ó–∞–ø–∏—Å–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏

        –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ü–û–°–õ–ï –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ Kaspi API
        """
        self.current_requests_count += 1

        if success:
            self.current_proxy.success_count += 1
        else:
            self.current_proxy.failure_count += 1

            # –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ ‚Üí mark as dead
            failure_rate = (
                self.current_proxy.failure_count /
                (self.current_proxy.success_count + self.current_proxy.failure_count)
            )

            if failure_rate > 0.5 and self.current_proxy.failure_count > 10:
                logger.error(
                    f"Proxy {self.current_proxy.id} has high failure rate "
                    f"({failure_rate:.1%}), marking as dead"
                )
                await self._mark_proxy_dead(self.current_proxy.id)

                # –†–æ—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
                await self._rotate_proxy()

    async def _mark_proxy_dead(self, proxy_id: UUID):
        """–ü–æ–º–µ—Ç–∏—Ç—å –ø—Ä–æ–∫—Å–∏ –∫–∞–∫ –º–µ—Ä—Ç–≤—ã–π"""
        query = "UPDATE proxies SET status = 'dead' WHERE id = $1"
        await conn.execute(query, proxy_id)

        # –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–µ—à–∞
        self.user_proxies = [p for p in self.user_proxies if p.id != proxy_id]

        # –ê–ª–µ—Ä—Ç –∞–¥–º–∏–Ω—É
        await send_admin_alert(f"Proxy {proxy_id} marked as dead")
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API Parser:


# new-backend/app/services/api_parser.py

# –î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞:
# ‚ú® NEW: Per-module rotators
proxy_rotators: Dict[tuple[UUID, str], ProxyRotator] = {}  # (user_id, module) ‚Üí ProxyRotator

async def get_user_proxy_rotator(user_id: UUID, module: str = 'demper') -> ProxyRotator:
    """
    –ü–æ–ª—É—á–∏—Ç—å ProxyRotator –¥–ª—è —é–∑–µ—Ä–∞ –∏ –º–æ–¥—É–ª—è (singleton –≤ –ø–∞–º—è—Ç–∏)

    –ö–∞–∂–¥–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è (user_id, module) –∏–º–µ–µ—Ç —Å–≤–æ–π rotator!
    """
    cache_key = (user_id, module)

    if cache_key not in proxy_rotators:
        rotator = ProxyRotator(user_id, module=module)
        await rotator.initialize()
        proxy_rotators[cache_key] = rotator

    return proxy_rotators[cache_key]


async def parse_product_by_sku(
    product_sku: str,
    user_id: UUID,  # ‚Üê –ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä!
    use_proxy: bool = True,
    ...
):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ —Å –ø—Ä–æ–∫—Å–∏-—Ä–æ—Ç–∞—Ü–∏–µ–π
    """

    if use_proxy:
        # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–∫—Å–∏ —é–∑–µ—Ä–∞
        rotator = await get_user_proxy_rotator(user_id)
        proxy = await rotator.get_current_proxy()  # –ê–≤—Ç–æ-—Ä–æ—Ç–∞—Ü–∏—è!

        # –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ —Å –ø—Ä–æ–∫—Å–∏
        proxy_url = f"{proxy.protocol}://{proxy.username}:{proxy.password}@{proxy.host}:{proxy.port}"

        client = httpx.AsyncClient(
            proxies={"http://": proxy_url, "https://": proxy_url},
            timeout=httpx.Timeout(30.0),
        )
    else:
        client = await get_http_client()

    try:
        # –°–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å
        response = await client.post(kaspi_url, json=payload)

        # ‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        if use_proxy:
            await rotator.record_request(success=True)

        return parse_response(response)

    except Exception as e:
        # ‚ùå –ó–∞–ø–∏—Å–∞—Ç—å –æ—à–∏–±–∫—É
        if use_proxy:
            await rotator.record_request(success=False)

        raise
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å demper_instance.py:


# new-backend/app/workers/demper_instance.py

async def process_products(products: List[Product], user_id: UUID):
    """
    –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –¥–ª—è –¥–µ–º–ø–∏–Ω–≥–∞

    ‚ú® –ò—Å–ø–æ–ª—å–∑—É–µ—Ç module='demper' –ø—Ä–æ–∫—Å–∏ –ø—É–ª (70 –ø—Ä–æ–∫—Å–∏)
    """
    for product in products:
        # –ü–∞—Ä—Å–∏–º —Ü–µ–Ω—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (—Å –ø—Ä–æ–∫—Å–∏ —Ä–æ—Ç–∞—Ü–∏–µ–π –¥–ª—è –¥–µ–º–ø–µ—Ä–∞)
        competitors = await parse_product_by_sku(
            product_sku=product.sku,
            user_id=user_id,  # ‚ú® –ü–µ—Ä–µ–¥–∞–µ–º user_id
            use_proxy=True    # ‚ú® –í–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Å–∏
        )
        # get_user_proxy_rotator –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç module='demper' (default)

        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ü–µ–Ω—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if should_update_price(product, competitors):
            await sync_product(
                product_id=product.id,
                new_price=calculate_new_price(competitors),
                user_id=user_id,  # ‚ú® –ü–µ—Ä–µ–¥–∞–µ–º user_id –¥–ª—è –ø—Ä–æ–∫—Å–∏ —Ä–æ—Ç–∞—Ü–∏–∏
                use_proxy=True
            )
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å orders_worker.py:


# new-backend/app/workers/orders_worker.py

# ‚ú® NEW: –ò–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞ —Å 60 –Ω–∞ 600 —Å–µ–∫—É–Ω–¥
ORDERS_POLLING_INTERVAL = 600  # 10 –º–∏–Ω—É—Ç (–±—ã–ª–æ 60 —Å–µ–∫—É–Ω–¥)

async def fetch_orders_for_store(store_id: UUID, user_id: UUID):
    """
    –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑—ã –∏–∑ Kaspi –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞

    ‚ú® –ò—Å–ø–æ–ª—å–∑—É–µ—Ç module='orders' –ø—Ä–æ–∫—Å–∏ –ø—É–ª (15 –ø—Ä–æ–∫—Å–∏)
    """
    # –ü–æ–ª—É—á–∏—Ç—å rotator –¥–ª—è –º–æ–¥—É–ª—è 'orders'
    rotator = await get_user_proxy_rotator(user_id, module='orders')  # ‚ú® module='orders'!
    proxy = await rotator.get_current_proxy()

    # –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ —Å –ø—Ä–æ–∫—Å–∏
    proxy_url = f"{proxy.protocol}://{proxy.username}:{proxy.password}@{proxy.host}:{proxy.port}"

    try:
        # –ó–∞–ø—Ä–æ—Å –∫ Kaspi orders API
        response = await http_client.get(
            "https://kaspi.kz/shop/api/v2/orders",
            proxies={"http://": proxy_url, "https://": proxy_url}
        )

        # ‚úÖ –£—Å–ø–µ—Ö
        await rotator.record_request(success=True)

        return response.json()

    except Exception as e:
        # ‚ùå –û—à–∏–±–∫–∞
        await rotator.record_request(success=False)
        raise
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å catalog sync (kaspi.py):


# new-backend/app/services/kaspi.py

async def get_products(store_id: UUID, user_id: UUID) -> List[Product]:
    """
    –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤

    ‚ú® –ò—Å–ø–æ–ª—å–∑—É–µ—Ç module='catalog' –ø—Ä–æ–∫—Å–∏ –ø—É–ª (10 –ø—Ä–æ–∫—Å–∏)
    """
    rotator = await get_user_proxy_rotator(user_id, module='catalog')  # ‚ú® module='catalog'!
    proxy = await rotator.get_current_proxy()

    proxy_url = f"{proxy.protocol}://{proxy.username}:{proxy.password}@{proxy.host}:{proxy.port}"

    try:
        response = await http_client.get(
            "https://mc.shop.kaspi.kz/bff/offer-view/list",
            proxies={"http://": proxy_url, "https://": proxy_url}
        )

        await rotator.record_request(success=True)
        return parse_products(response.json())

    except Exception as e:
        await rotator.record_request(success=False)
        raise
–§–∞–π–ª—ã:

–°–æ–∑–¥–∞—Ç—å: new-backend/app/core/proxy_rotator.py (~350 —Å—Ç—Ä–æ–∫)
–ò–∑–º–µ–Ω–∏—Ç—å: new-backend/app/services/api_parser.py (–¥–æ–±–∞–≤–∏—Ç—å use_proxy, rotator, per-module support)
–ò–∑–º–µ–Ω–∏—Ç—å: new-backend/app/workers/demper_instance.py (–ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å user_id, module='demper')
–ò–∑–º–µ–Ω–∏—Ç—å: new-backend/app/workers/orders_worker.py (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å module='orders', ORDERS_POLLING_INTERVAL=600)
–ò–∑–º–µ–Ω–∏—Ç—å: new-backend/app/services/kaspi.py (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å module='catalog')
–°—Ç—Ä–∞—Ç–µ–≥–∏—è 4: –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ (P1 - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–¶–µ–ª—å: –ù–µ –¥–µ–º–ø–∏—Ç—å –≤—Å–µ 500 —Ç–æ–≤–∞—Ä–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ

–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞:

Hot products (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24—á)
High margin (–±–æ–ª—å—à–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –º–∏–Ω. —Ü–µ–Ω–æ–π –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏)
Recent activity (–Ω–µ–¥–∞–≤–Ω–∏–µ –∑–∞–∫–∞–∑—ã/–ø—Ä–æ—Å–º–æ—Ç—Ä—ã)
Low priority (—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Ü–µ–Ω—ã, –Ω–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å)
–ê–ª–≥–æ—Ä–∏—Ç–º:


# –í demper_instance.py, fetch_products_for_instance():

SELECT
    p.*,
    CASE
        WHEN ph.price_changed_at > NOW() - INTERVAL '24 hours' THEN 1  -- Hot
        WHEN p.current_price - p.min_price > 1000 THEN 2                -- High margin
        WHEN p.last_order_at > NOW() - INTERVAL '7 days' THEN 3         -- Active
        ELSE 4                                                           -- Low priority
    END as priority
FROM products p
LEFT JOIN (
    SELECT product_id, MAX(created_at) as price_changed_at
    FROM price_history
    WHERE created_at > NOW() - INTERVAL '24 hours'
    GROUP BY product_id
) ph ON ph.product_id = p.id
WHERE p.bot_active = TRUE
ORDER BY priority ASC, p.last_check_time ASC NULLS FIRST
LIMIT 100  -- –£–º–µ–Ω—å—à–∏—Ç—å —Å 500 –¥–æ 100 –∑–∞ —Ü–∏–∫–ª
–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª:

Priority 1 (Hot): –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã
Priority 2 (High margin): –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
Priority 3 (Active): –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
Priority 4 (Low): –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞
–§–∞–π–ª—ã:

–ò–∑–º–µ–Ω–∏—Ç—å: new-backend/app/workers/demper_instance.py (—Å—Ç—Ä–æ–∫–∏ 303-350)
–î–æ–±–∞–≤–∏—Ç—å: new-backend/migrations/versions/20260131_add_product_priority.py
–°—Ç—Ä–∞—Ç–µ–≥–∏—è 5: Proxy Provider Integration (P0 - –ö—Ä–∏—Ç–∏—á–Ω–æ)
–¶–µ–ª—å: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–∫—É–ø–∫–∞ –ø—Ä–æ–∫—Å–∏ –∫–æ–≥–¥–∞ –ø—É–ª –∏—Å—Ç–æ—â–∞–µ—Ç—Å—è

–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã (–Ω–∞ –≤—ã–±–æ—Ä):

Proxy6.net - IPv6 –ø—Ä–æ–∫—Å–∏ –∏–∑ –ù–∏–¥–µ—Ä–ª–∞–Ω–¥–æ–≤

–¶–µ–Ω–∞: ~$11 –∑–∞ 100 –ø—Ä–æ–∫—Å–∏
API: https://proxy6.net/developers
–ü–æ–¥–¥–µ—Ä–∂–∫–∞: HTTP, SOCKS5
–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã (–µ—Å–ª–∏ –Ω–∏–¥–µ—Ä–ª–∞–Ω–¥—Å–∫–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç):

Soax.com - –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–µ residential (–¥–æ—Ä–æ–∂–µ, ~$100/100 –ø—Ä–æ–∫—Å–∏)
Brightdata - –ü—Ä–µ–º–∏—É–º, –Ω–æ –Ω–∞–¥–µ–∂–Ω—ã–µ
API Integration:


# new-backend/app/services/proxy_provider.py

import httpx
from typing import List

class ProxyProviderClient:
    """
    –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Proxy6.net API
    """

    def __init__(self):
        self.api_key = settings.proxy6_api_key
        self.base_url = "https://proxy6.net/api"

    async def purchase_proxies(
        self,
        count: int,
        period_days: int = 30,
        country: str = "nl",  # Netherlands
        version: int = 6  # IPv6
    ) -> List[ProxyCredentials]:
        """
        –ó–∞–∫—É–ø–∏—Ç—å –ø—Ä–æ–∫—Å–∏ —á–µ—Ä–µ–∑ API

        Docs: https://proxy6.net/developers/buy
        """
        url = f"{self.base_url}/{self.api_key}/buy/{count}/{period_days}/{country}/{version}"

        async with httpx.AsyncClient() as client:
            response = await client.get(url)
            data = response.json()

            if data['status'] != 'yes':
                raise ProxyPurchaseError(f"Failed to buy proxies: {data}")

            # –ü–∞—Ä—Å–∏–º –∫—É–ø–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–∫—Å–∏
            proxies = []
            for proxy_id, proxy_data in data['list'].items():
                proxies.append(ProxyCredentials(
                    host=proxy_data['host'],
                    port=proxy_data['port_http'],
                    username=proxy_data['user'],
                    password=proxy_data['pass'],
                    protocol='http',
                    country=country
                ))

            return proxies

    async def check_balance(self) -> float:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –Ω–∞ Proxy6.net
        """
        url = f"{self.base_url}/{self.api_key}/getbalance"

        async with httpx.AsyncClient() as client:
            response = await client.get(url)
            data = response.json()

            if data['status'] == 'yes':
                return float(data['balance'])

            raise ProxyProviderError(f"Failed to get balance: {data}")


# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ProxyAllocator:

async def ensure_proxy_pool_sufficient(required_count: int = 500):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –ø—Ä–æ–∫—Å–∏ –≤ –ø—É–ª–µ
    –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –∑–∞–∫—É–ø–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    """
    query = "SELECT COUNT(*) FROM proxies WHERE status = 'available'"
    available_count = await conn.fetchval(query)

    if available_count < required_count:
        shortage = required_count - available_count

        logger.warning(f"Proxy pool low: {available_count}/{required_count}, buying {shortage}")

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å
        provider = ProxyProviderClient()
        balance = await provider.check_balance()

        estimated_cost = (shortage / 100) * 11  # $11 per 100 proxies

        if balance < estimated_cost:
            await send_admin_alert(
                f"‚ö†Ô∏è Low proxy provider balance: ${balance:.2f}, need ${estimated_cost:.2f}"
            )
            raise InsufficientFundsError("Not enough funds to buy proxies")

        # –ó–∞–∫—É–ø–∏—Ç—å
        new_proxies = await provider.purchase_proxies(count=shortage)

        # –î–æ–±–∞–≤–∏—Ç—å –≤ –ë–î
        for proxy in new_proxies:
            await conn.execute(
                """
                INSERT INTO proxies (host, port, username, password, protocol, country, status)
                VALUES ($1, $2, $3, $4, $5, $6, 'available')
                """,
                proxy.host, proxy.port, proxy.username,
                proxy.password, proxy.protocol, proxy.country
            )

        logger.info(f"‚úÖ Purchased {len(new_proxies)} new proxies")

        return new_proxies
–ö—Ä–æ–Ω-–¥–∂–æ–±–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–∫—É–ø–∫–∏:


# new-backend/app/workers/proxy_pool_monitor.py

async def monitor_proxy_pool():
    """
    –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–∫—Å–∏ –≤ –ø—É–ª–µ
    –ï—Å–ª–∏ < 500 available ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—É–ø–∞–µ—Ç
    """
    while True:
        try:
            await ensure_proxy_pool_sufficient(required_count=500)
        except Exception as e:
            logger.error(f"Proxy pool monitoring error: {e}")

        await asyncio.sleep(6 * 3600)  # 6 —á–∞—Å–æ–≤
Environment Variables:


# .env
PROXY6_API_KEY=your_proxy6_api_key_here
PROXY_POOL_MIN_SIZE=500  # –ú–∏–Ω–∏–º—É–º –ø—Ä–æ–∫—Å–∏ –≤ –ø—É–ª–µ
PROXY_AUTO_PURCHASE=true  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–∫—É–ø–∫–∞
–§–∞–π–ª—ã:

–°–æ–∑–¥–∞—Ç—å: new-backend/app/services/proxy_provider.py (~200 —Å—Ç—Ä–æ–∫)
–°–æ–∑–¥–∞—Ç—å: new-backend/app/workers/proxy_pool_monitor.py (~100 —Å—Ç—Ä–æ–∫)
–ò–∑–º–µ–Ω–∏—Ç—å: new-backend/app/config.py (–¥–æ–±–∞–≤–∏—Ç—å PROXY6_API_KEY)
–°—Ç—Ä–∞—Ç–µ–≥–∏—è 6: –ë–∞—Ç—á–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Ü–µ–Ω (P2 - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–¶–µ–ª—å: –í–º–µ—Å—Ç–æ 500 individual –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí 10-20 batch –∑–∞–ø—Ä–æ—Å–æ–≤

–ü—Ä–æ–±–ª–µ–º–∞: Kaspi API pricefeed/upload/merchant/process –ø—Ä–∏–Ω–∏–º–∞–µ—Ç:

–õ–∏–±–æ –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä (SKU + —Ü–µ–Ω–∞)
–õ–∏–±–æ XML —Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º —Ç–æ–≤–∞—Ä–æ–≤
–†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å XML batch upload

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:

–°–æ–∑–¥–∞—Ç—å batch_sync_products() –≤ api_parser.py:


async def batch_sync_products(
    products: List[ProductUpdate],
    session: dict,
    batch_size: int = 50
) -> BatchResult:
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—ã –±–∞—Ç—á–µ–º —á–µ—Ä–µ–∑ XML upload
    1 –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 50!
    """
    xml = generate_pricefeed_xml(products)  # YML —Ñ–æ—Ä–º–∞—Ç Kaspi

    await kaspi_rate_limiter.acquire()  # –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –±–∞—Ç—á

    response = await http_client.post(
        "https://mc.shop.kaspi.kz/pricefeed/upload/xml",
        files={"file": ("pricefeed.xml", xml, "application/xml")},
        headers=get_auth_headers(session)
    )
–ò–∑–º–µ–Ω–∏—Ç—å –¥–µ–º–ø–∏–Ω–≥ —Ü–∏–∫–ª:

–°–æ–±—Ä–∞—Ç—å –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Å–ø–∏—Å–æ–∫
–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ 50 —Ç–æ–≤–∞—Ä–æ–≤
–û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–∞—Ç—á–µ–º –≤–º–µ—Å—Ç–æ –ø–æ –æ–¥–Ω–æ–º—É
–≠–∫–æ–Ω–æ–º–∏—è:

–ë—ã–ª–æ: 500 —Ç–æ–≤–∞—Ä–æ–≤ √ó 1 –∑–∞–ø—Ä–æ—Å = 500 –∑–∞–ø—Ä–æ—Å–æ–≤
–°—Ç–∞–ª–æ: 500 —Ç–æ–≤–∞—Ä–æ–≤ / 50 –±–∞—Ç—á = 10 –∑–∞–ø—Ä–æ—Å–æ–≤
–≠–∫–æ–Ω–æ–º–∏—è: 50x!
–§–∞–π–ª—ã:

–ò–∑–º–µ–Ω–∏—Ç—å: new-backend/app/services/api_parser.py (+150 —Å—Ç—Ä–æ–∫)
–ò–∑–º–µ–Ω–∏—Ç—å: new-backend/app/workers/demper_instance.py (–∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É sync)
–°—Ç—Ä–∞—Ç–µ–≥–∏—è 4: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (P1 - –í—ã—Å–æ–∫–∏–π)
–¶–µ–ª—å: –ù–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å —Ü–µ–Ω—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å

–†–µ—à–µ–Ω–∏–µ:

Redis –∫–µ—à –¥–ª—è competitor prices:


# –í parse_product_by_sku():

cache_key = f"kaspi:competitors:{product_sku}"
cached = await redis.get(cache_key)

if cached and not force_refresh:
    return json.loads(cached)

# Fetch from Kaspi API
await kaspi_rate_limiter.acquire()
response = await http_client.post(kaspi_url, ...)

# –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 5 –º–∏–Ω—É—Ç
await redis.setex(cache_key, 300, json.dumps(result))
Smart refresh strategy:

–ï—Å–ª–∏ –∫–µ—à –µ—Å—Ç—å –∏ < 5 –º–∏–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–µ—à
–ï—Å–ª–∏ —Ç–æ–≤–∞—Ä Hot (priority 1) ‚Üí force_refresh=True
–ï—Å–ª–∏ —Ç–æ–≤–∞—Ä Low priority ‚Üí –∫–µ—à –Ω–∞ 30 –º–∏–Ω—É—Ç
–≠–∫–æ–Ω–æ–º–∏—è:

Priority 1 (10% —Ç–æ–≤–∞—Ä–æ–≤): refresh –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω
Priority 2-3 (40%): –∫–µ—à 10 –º–∏–Ω ‚Üí —ç–∫–æ–Ω–æ–º–∏—è 70%
Priority 4 (50%): –∫–µ—à 30 –º–∏–Ω ‚Üí —ç–∫–æ–Ω–æ–º–∏—è 90%
–°—Ä–µ–¥–Ω—è—è —ç–∫–æ–Ω–æ–º–∏—è: ~60% –∑–∞–ø—Ä–æ—Å–æ–≤!
–§–∞–π–ª—ã:

–ò–∑–º–µ–Ω–∏—Ç—å: new-backend/app/services/api_parser.py (—Å—Ç—Ä–æ–∫–∏ 341-450)
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Redis client
–°—Ç—Ä–∞—Ç–µ–≥–∏—è 5: –û—á–µ—Ä–µ–¥—å —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ (P2 - –°—Ä–µ–¥–Ω–∏–π)
–¶–µ–ª—å: Urgent –∑–∞–ø—Ä–æ—Å—ã (–ø—Ä–æ–¥–∞–∂–∏, –ø—Ä–µ–¥–∑–∞–∫–∞–∑—ã) –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –¥–µ–º–ø–∏–Ω–≥–æ–º

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:

Priority Queue –≤ Redis:


# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:
# 1 - –°—Ä–æ—á–Ω—ã–µ (orders, preorders)
# 2 - –î–µ–º–ø–∏–Ω–≥ hot —Ç–æ–≤–∞—Ä–æ–≤
# 3 - –î–µ–º–ø–∏–Ω–≥ –æ–±—ã—á–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
# 4 - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞

await redis.zadd(
    "kaspi:request_queue",
    {
        json.dumps(request): priority_score
    }
)
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—á–µ—Ä–µ–¥–∏:

Worker —á–∏—Ç–∞–µ—Ç –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
–£–≤–∞–∂–∞–µ—Ç Kaspi rate limit
–ï—Å–ª–∏ –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω ‚Üí –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å
–§–∞–π–ª—ã:

–°–æ–∑–¥–∞—Ç—å: new-backend/app/core/priority_queue.py (–Ω–æ–≤—ã–π —Ñ–∞–π–ª, ~200 —Å—Ç—Ä–æ–∫)
–ò–∑–º–µ–Ω–∏—Ç—å: new-backend/app/workers/demper_instance.py (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å)
–°—Ç—Ä–∞—Ç–µ–≥–∏—è 6: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π backoff –ø—Ä–∏ 429 (P1 - –í—ã—Å–æ–∫–∏–π)
–¶–µ–ª—å: –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ 429 –æ—Ç Kaspi ‚Üí —É–º–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞

–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:


# api_parser.py, —Å—Ç—Ä–æ–∫–∞ 297:
if response.status_code == 429:
    await asyncio.sleep(random.uniform(0.5, 2.0))  # ‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è!
–†–µ—à–µ–Ω–∏–µ - Exponential Backoff:


async def smart_backoff_on_429(attempt: int, max_attempts: int = 5):
    """
    –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Å jitter

    Attempt 1: 5-10 —Å–µ–∫
    Attempt 2: 30-60 —Å–µ–∫
    Attempt 3: 2-5 –º–∏–Ω
    Attempt 4: 10-20 –º–∏–Ω
    Attempt 5: Fail with CircuitOpenError
    """
    base_delay = 5 * (2 ** attempt)  # Exponential
    jitter = random.uniform(0.5, 1.5)  # +/- 50%
    delay = min(base_delay * jitter, 20 * 60)  # Max 20 –º–∏–Ω

    logger.warning(f"429 detected, backing off for {delay:.1f}s (attempt {attempt})")
    await asyncio.sleep(delay)
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:

–ü–æ—Å–ª–µ 429 ‚Üí —Å–Ω–∏–∑–∏—Ç—å Kaspi rate limit –¥–æ 50% –Ω–∞ 30 –º–∏–Ω—É—Ç
–ü–æ—Å–ª–µ 3 –ø–æ–¥—Ä—è–¥ 429 ‚Üí Circuit Breaker ‚Üí OPEN state
–û–ø–æ–≤–µ—Å—Ç–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ webhook
–§–∞–π–ª—ã:

–ò–∑–º–µ–Ω–∏—Ç—å: new-backend/app/services/api_parser.py (—Å—Ç—Ä–æ–∫–∏ 269-310)
–ò–∑–º–µ–Ω–∏—Ç—å: new-backend/app/core/circuit_breaker.py (–¥–æ–±–∞–≤–∏—Ç—å 429 handling)
–ò—Ç–æ–≥–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

500 —Ç–æ–≤–∞—Ä–æ–≤ √ó 2 –∑–∞–ø—Ä–æ—Å–∞ (parse + sync) = 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ / 3 –º–∏–Ω
= 333 –∑–∞–ø—Ä–æ—Å–∞/–º–∏–Ω
–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ: 333 / 8.33 = 40x ‚ùå
–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
–° –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–µ–π (100 —Ç–æ–≤–∞—Ä–æ–≤/—Ü–∏–∫–ª):

Priority 1 (10 —Ç–æ–≤–∞—Ä–æ–≤): 10 √ó 1 parse = 10 –∑–∞–ø—Ä–æ—Å–æ–≤
Priority 2-4 (90 —Ç–æ–≤–∞—Ä–æ–≤): –ö–µ—à, parse —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ = ~30 –∑–∞–ø—Ä–æ—Å–æ–≤
–ò–¢–û–ì–û parse: ~40 –∑–∞–ø—Ä–æ—Å–æ–≤
–° –±–∞—Ç—á–∏–Ω–≥–æ–º (50 —Ç–æ–≤–∞—Ä–æ–≤/–±–∞—Ç—á):

100 —Ç–æ–≤–∞—Ä–æ–≤ / 50 = 2 batch sync –∑–∞–ø—Ä–æ—Å–∞
–ò—Ç–æ–≥–æ –∑–∞ —Ü–∏–∫–ª:


40 parse + 2 batch sync = 42 –∑–∞–ø—Ä–æ—Å–∞ / 3 –º–∏–Ω = 14 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω
–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: 14 / 8.33 = 1.68x ‚ö†Ô∏è (–≤—Å–µ –µ—â–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ, –Ω–æ –ø—Ä–∏–µ–º–ª–µ–º–æ–µ)
–° –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º (60% —ç–∫–æ–Ω–æ–º–∏—è):


14 √ó 0.4 = 5.6 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω
–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: 5.6 / 8.33 = 0.67x ‚úÖ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞!)
–ü–ª—é—Å buffer –¥–ª—è –ø—Ä–µ–¥–∑–∞–∫–∞–∑–æ–≤/–ø—Ä–æ–¥–∞–∂:

–û—Å—Ç–∞–µ—Ç—Å—è ~2.7 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π ‚úÖ
–ò—Ç–æ–≥–æ–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
–ë–µ–∑ –ø—Ä–æ–∫—Å–∏ (—Ç–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è):

500 —Ç–æ–≤–∞—Ä–æ–≤ √ó 2 –∑–∞–ø—Ä–æ—Å–∞ = 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ / 3 –º–∏–Ω = 333 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω
Kaspi –ª–∏–º–∏—Ç: 8.33 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω
–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ: 40x ‚ùå ‚Üí –ë–ê–ù
–° per-user proxy pool (—Ä–µ—à–µ–Ω–∏–µ):

–Æ–∑–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 6 —Å–≤–æ–∏—Ö –ø—Ä–æ–∫—Å–∏ –∑–∞ —Ü–∏–∫–ª:
- –ü—Ä–æ–∫—Å–∏ 1: 249 –∑–∞–ø—Ä–æ—Å–æ–≤ (parse —Ç–æ–≤–∞—Ä—ã 1-249)
- –ü—Ä–æ–∫—Å–∏ 2: 249 –∑–∞–ø—Ä–æ—Å–æ–≤ (parse —Ç–æ–≤–∞—Ä—ã 250-498)
- –ü—Ä–æ–∫—Å–∏ 3: 2 –∑–∞–ø—Ä–æ—Å–∞ (parse —Ç–æ–≤–∞—Ä—ã 499-500)
- –ü—Ä–æ–∫—Å–∏ 4: 249 –∑–∞–ø—Ä–æ—Å–æ–≤ (sync —Ç–æ–≤–∞—Ä—ã 1-249)
- –ü—Ä–æ–∫—Å–∏ 5: 249 –∑–∞–ø—Ä–æ—Å–æ–≤ (sync —Ç–æ–≤–∞—Ä—ã 250-498)
- –ü—Ä–æ–∫—Å–∏ 6: 2 –∑–∞–ø—Ä–æ—Å–∞ (sync —Ç–æ–≤–∞—Ä—ã 499-500)

–ò–¢–û–ì–û: 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ ~2 –º–∏–Ω—É—Ç—ã ‚úÖ
–ö–∞–∂–¥—ã–π –ø—Ä–æ–∫—Å–∏: 249 < 250 –ª–∏–º–∏—Ç–∞ ‚úÖ
–ù–∏–∫–∞–∫–∏—Ö –±–∞–Ω–æ–≤ ‚úÖ
–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –¥–µ–º–ø–∏–Ω–≥ - –≤—Å–µ 500 —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ 2 –º–∏–Ω—É—Ç—ã
‚úÖ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ - –∫–∞–∫ —É –ê–ª–≥–∞—Ç–æ–ø –∏ –î–µ–º–µ—Ç—Ä–∞
‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å - –¥–æ 1000+ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —é–∑–µ—Ä–∞
‚úÖ –ò–∑–æ–ª—è—Ü–∏—è - –ø—Ä–æ–∫—Å–∏ —é–∑–µ—Ä–∞ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –¥—Ä—É–≥–∏—Ö
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è - –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
Phase 0: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ (–î–µ–Ω—å 1)
–¶–µ–ª—å: –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –Ω–∏–¥–µ—Ä–ª–∞–Ω–¥—Å–∫–∏–µ IPv6 —Ä–∞–±–æ—Ç–∞—é—Ç —Å Kaspi

–ö—É–ø–∏—Ç—å 10 —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø—Ä–æ–∫—Å–∏ (1 —á–∞—Å)

Proxy6.net: 10 –ø—Ä–æ–∫—Å–∏ IPv6 NL –∑–∞ ~$1.10
–ü–æ–ª—É—á–∏—Ç—å credentials
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç (2 —á–∞—Å–∞)


# scripts/test_proxies.py
async def test_kaspi_with_proxy(proxy):
    # –¢–µ—Å—Ç 1: –î–æ—Å—Ç—É–ø –∫ kaspi.kz
    # –¢–µ—Å—Ç 2: –ó–∞–ø—Ä–æ—Å –∫ mc.shop.kaspi.kz (merchant center)
    # –¢–µ—Å—Ç 3: Parse product API
    # –¢–µ—Å—Ç 4: Sync product API
–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (1 —á–∞—Å)

–ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç ‚úÖ ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å NL IPv6
–ï—Å–ª–∏ –ù–ï —Ä–∞–±–æ—Ç–∞—é—Ç ‚ùå ‚Üí –Ω—É–∂–Ω—ã KZ residential (–¥–æ—Ä–æ–∂–µ)
–ò—Ç–æ–≥–æ Phase 0: ~4 —á–∞—Å–∞ (0.5 –¥–Ω—è)

–ö–†–ò–¢–ò–ß–ù–û: –ù–µ –Ω–∞—á–∏–Ω–∞—Ç—å Phase 1 –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ —á—Ç–æ –ø—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞—é—Ç!

Phase 1: Database & Core Infrastructure (–î–µ–Ω—å 2-3)
–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î - Proxy Tables (3 —á–∞—Å–∞)

–°–æ–∑–¥–∞—Ç—å: migrations/20260131_add_proxy_pool.py
–¢–∞–±–ª–∏—Ü—ã: proxies, proxy_usage_log
–ò–Ω–¥–µ–∫—Å—ã
Proxy Models (2 —á–∞—Å–∞)

–°–æ–∑–¥–∞—Ç—å: app/models/proxy.py
Pydantic schemas
ProxyRotator –∫–ª–∞—Å—Å (6 —á–∞—Å–æ–≤)

–°–æ–∑–¥–∞—Ç—å: app/core/proxy_rotator.py
–õ–æ–≥–∏–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 249 –∑–∞–ø—Ä–æ—Å–æ–≤
In-memory tracking
–¢–µ—Å—Ç—ã (unit tests)
ProxyAllocator —Å–µ—Ä–≤–∏—Å (4 —á–∞—Å–∞)

–°–æ–∑–¥–∞—Ç—å: app/services/proxy_allocator.py
allocate_proxies_to_user()
deallocate_proxies_from_user()
–ò—Ç–æ–≥–æ Phase 1: ~15 —á–∞—Å–æ–≤ (2 –¥–Ω—è)

Phase 2: Proxy Provider Integration (–î–µ–Ω—å 4)
Proxy6.net API Client (4 —á–∞—Å–∞)

–°–æ–∑–¥–∞—Ç—å: app/services/proxy_provider.py
purchase_proxies()
check_balance()
–¢–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º API (staging)
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–∫—É–ø–∫–∞ (3 —á–∞—Å–∞)

ensure_proxy_pool_sufficient()
–ö—Ä–æ–Ω-–¥–∂–æ–±–∞: proxy_pool_monitor.py
–ü–µ—Ä–≤–∏—á–Ω–æ–µ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É–ª–∞ (1 —á–∞—Å)

–°–∫—Ä–∏–ø—Ç: scripts/initial_proxy_purchase.py
–ó–∞–∫—É–ø–∏—Ç—å 500 –ø—Ä–æ–∫—Å–∏ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞
–î–æ–±–∞–≤–∏—Ç—å –≤ –ë–î
–ò—Ç–æ–≥–æ Phase 2: ~8 —á–∞—Å–æ–≤ (1 –¥–µ–Ω—å)

Phase 3: Integration —Å –¥–µ–º–ø–∏–Ω–≥–æ–º (–î–µ–Ω—å 5-6)
–ò–∑–º–µ–Ω–∏—Ç—å api_parser.py (6 —á–∞—Å–æ–≤)

–î–æ–±–∞–≤–∏—Ç—å use_proxy –ø–∞—Ä–∞–º–µ—Ç—Ä
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ProxyRotator (per-module support)
get_user_proxy_rotator(user_id, module='demper')
record_request() –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞
–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥—É–ª–µ–π —á–µ—Ä–µ–∑ cache_key=(user_id, module)
–ò–∑–º–µ–Ω–∏—Ç—å demper_instance.py (4 —á–∞—Å–æ–≤)

–ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å user_id –≤ parse_product_by_sku
–ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å user_id –≤ sync_product
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç module='demper' (70 –ø—Ä–æ–∫—Å–∏)
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏-—Ä–æ—Ç–∞—Ü–∏–∏
–ò–∑–º–µ–Ω–∏—Ç—å orders_worker.py (3 —á–∞—Å–∞)

–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å get_user_proxy_rotator(user_id, module='orders')
–ò–∑–º–µ–Ω–∏—Ç—å ORDERS_POLLING_INTERVAL —Å 60 –Ω–∞ 600 —Å–µ–∫—É–Ω–¥ (10 –º–∏–Ω—É—Ç)
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–∏ 15 –ø—Ä–æ–∫—Å–∏ (–Ω–µ –∫–æ–Ω–∫—É—Ä–∏—Ä—É–µ—Ç —Å –¥–µ–º–ø–µ—Ä–æ–º!)
–ò–∑–º–µ–Ω–∏—Ç—å kaspi.py (catalog sync) (2 —á–∞—Å–∞)

–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å get_user_proxy_rotator(user_id, module='catalog')
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–∏ 10 –ø—Ä–æ–∫—Å–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–∞—Ç–∞–ª–æ–≥–∞
Playwright –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (6 —á–∞—Å–æ–≤)

–ò–∑–º–µ–Ω–∏—Ç—å: app/core/browser_farm.py
launch_browser_with_proxy()
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç module='reserve' –ø—Ä–æ–∫—Å–∏ (5 —à—Ç—É–∫)
–ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø—Ä–æ–∫—Å–∏ –≤ kaspi_auth_service
–ò—Ç–æ–≥–æ Phase 3: ~21 —á–∞—Å–æ–≤ (2.5 –¥–Ω—è)

Phase 4: Billing Integration (–î–µ–Ω—å 7)
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ (3 —á–∞—Å–∞)

–ò–∑–º–µ–Ω–∏—Ç—å: app/routers/billing.py
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã ‚Üí allocate_proxies_to_user()
–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (InsufficientProxiesError)
Subscription cleanup worker (3 —á–∞—Å–∞)

–°–æ–∑–¥–∞—Ç—å: app/workers/subscription_cleanup.py
–ö—Ä–æ–Ω –∫–∞–∂–¥—ã–µ 1 —á–∞—Å
–û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø—Ä–æ–∫—Å–∏ –æ—Ç –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
Admin –ø–∞–Ω–µ–ª—å –¥–ª—è –ø—Ä–æ–∫—Å–∏ (4 —á–∞—Å–∞)

Dashboard: —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–∫—Å–∏ –≤ –ø—É–ª–µ
–°–∫–æ–ª—å–∫–æ –≤—ã–¥–µ–ª–µ–Ω–æ —é–∑–µ—Ä–∞–º
Health check —Å—Ç–∞—Ç—É—Å
–ö–Ω–æ–ø–∫–∞ "–ó–∞–∫—É–ø–∏—Ç—å –ø—Ä–æ–∫—Å–∏ –≤—Ä—É—á–Ω—É—é"
–ò—Ç–æ–≥–æ Phase 4: ~10 —á–∞—Å–æ–≤ (1.5 –¥–Ω—è)

Phase 5: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã (–î–µ–Ω—å 8)
–ú–µ—Ç—Ä–∏–∫–∏ (4 —á–∞—Å–∞)

Endpoint: /health/proxies
Metrics: available_count, allocated_count, dead_count
Per-user: proxies_used, current_proxy, requests_on_current
–ê–ª–µ—Ä—Ç—ã (2 —á–∞—Å–∞)

Webhook –µ—Å–ª–∏ proxy pool < 100
Webhook –µ—Å–ª–∏ –ø—Ä–æ–∫—Å–∏ —é–∑–µ—Ä–∞ –≤—Å–µ dead
Email –∞–¥–º–∏–Ω—É –ø—Ä–∏ –∑–∞–∫—É–ø–∫–µ –ø—Ä–æ–∫—Å–∏
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (2 —á–∞—Å–∞)

Structured logging –¥–ª—è proxy rotation
Grafana/Loki –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–ò—Ç–æ–≥–æ Phase 5: ~8 —á–∞—Å–æ–≤ (1 –¥–µ–Ω—å)

Phase 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–î–µ–Ω—å 9-10)
Unit —Ç–µ—Å—Ç—ã (6 —á–∞—Å–æ–≤)

ProxyRotator tests
ProxyAllocator tests
Mock Proxy6.net API
Integration —Ç–µ—Å—Ç—ã (6 —á–∞—Å–æ–≤)

–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –æ–ø–ª–∞—Ç–∞ ‚Üí –≤—ã–¥–µ–ª–µ–Ω–∏–µ ‚Üí –¥–µ–º–ø–∏–Ω–≥
–¢–µ—Å—Ç —Ä–æ—Ç–∞—Ü–∏–∏ –Ω–∞ 500 —Ç–æ–≤–∞—Ä–∞—Ö
–¢–µ—Å—Ç resting –∏ reuse
Load —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (4 —á–∞—Å–æ–≤)

10 —é–∑–µ—Ä–æ–≤ √ó 500 —Ç–æ–≤–∞—Ä–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
–ü—Ä–æ–≤–µ—Ä–∫–∞ isolation (–Ω–µ –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—Ç –∑–∞ –ø—Ä–æ–∫—Å–∏)
Memory leaks check
–ò—Ç–æ–≥–æ Phase 6: ~16 —á–∞—Å–æ–≤ (2 –¥–Ω—è)

–û–±—â–∏–π timeline
Phase	–î–Ω–∏	–ß–∞—Å—ã	–û–ø–∏—Å–∞–Ω–∏–µ
Phase 0	0.5	4	–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ —Å Kaspi
Phase 1	2	15	Database & ProxyRotator
Phase 2	1	8	Proxy Provider –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
Phase 3	2.5	21	–î–µ–º–ø–∏–Ω–≥ + per-module –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
Phase 4	1.5	10	Billing –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
Phase 5	1	8	–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
Phase 6	2	16	–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ò–¢–û–ì–û	10.5 –¥–Ω–µ–π	82 —á–∞—Å–∞	Full implementation
–° 1 —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º: 10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π (2 –Ω–µ–¥–µ–ª–∏)
–° 2 —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏: 5-6 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π (1 –Ω–µ–¥–µ–ª—è)

–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è
–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã (—Å–æ–∑–¥–∞—Ç—å):
–§–∞–π–ª	–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ	–°—Ç—Ä–æ–∫–∏	–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
migrations/versions/20260131_add_proxy_pool.py	DB schema –¥–ª—è –ø—Ä–æ–∫—Å–∏	~100	P0
app/models/proxy.py	Proxy models	~80	P0
app/core/proxy_rotator.py	–†–æ—Ç–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 249 –∑–∞–ø—Ä–æ—Å–æ–≤	~350	P0
app/services/proxy_allocator.py	–í—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ —é–∑–µ—Ä–∞–º	~200	P0
app/services/proxy_provider.py	Proxy6.net API client	~200	P0
app/workers/proxy_pool_monitor.py	–ö—Ä–æ–Ω –¥–ª—è –∞–≤—Ç–æ–∑–∞–∫—É–ø–∫–∏	~100	P0
app/workers/subscription_cleanup.py	–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏	~100	P1
scripts/test_proxies.py	–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏	~150	P0
scripts/initial_proxy_purchase.py	–ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–∫—É–ø–∫–∞	~50	P1
–ò–∑–º–µ–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã:
–§–∞–π–ª	–ò–∑–º–µ–Ω–µ–Ω–∏—è	–°—Ç—Ä–æ–∫–∏	–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
app/services/api_parser.py	–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ProxyRotator, use_proxy –ø–∞—Ä–∞–º–µ—Ç—Ä, per-module support	+200	P0
app/workers/demper_instance.py	–ü–µ—Ä–µ–¥–∞—á–∞ user_id, module='demper'	+50	P0
app/workers/orders_worker.py	module='orders', ORDERS_POLLING_INTERVAL=600 (10 –º–∏–Ω)	+60	P0
app/services/kaspi.py	module='catalog' –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏	+40	P0
app/routers/billing.py	–í—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ —Å per-module distribution	+30	P0
app/config.py	PROXY6_API_KEY, proxy settings	+15	P0
app/core/browser_farm.py	launch_browser_with_proxy()	+50	P1
app/services/kaspi_auth_service.py	–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ –¥–ª—è auth	+30	P1
–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
Phase 0: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏

# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
python scripts/test_proxies.py

# –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
# ‚úÖ Proxy 123.45.67.89:8080 - kaspi.kz accessible
# ‚úÖ Proxy 123.45.67.89:8080 - merchant center accessible
# ‚úÖ Proxy 123.45.67.89:8080 - parse product API works
# ‚úÖ Proxy 123.45.67.89:8080 - sync product API works
# Total: 9/10 proxies working (90% success rate)

# –ï—Å–ª–∏ < 80% success ‚Üí –Ω—É–∂–Ω—ã –¥—Ä—É–≥–∏–µ –ø—Ä–æ–∫—Å–∏ (KZ residential)
Phase 1-4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

-- 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∫—Å–∏ –≤ –ë–î
SELECT
    status,
    COUNT(*) as count,
    COUNT(DISTINCT user_id) as users
FROM proxies
GROUP BY status;

-- –û–∂–∏–¥–∞–µ—Ç—Å—è:
-- available  | 400 | 0      (—Å–≤–æ–±–æ–¥–Ω—ã–µ)
-- allocated  | 100 | 1      (–≤—ã–¥–µ–ª–µ–Ω—ã —é–∑–µ—Ä—É)
-- resting    | 0   | 0      (–æ—Ç–¥—ã—Ö–∞—é—Ç)
-- dead       | 0   | 0      (–º–µ—Ä—Ç–≤—ã–µ)

# 2. –¢–µ—Å—Ç –æ–ø–ª–∞—Ç—ã –∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–∫—Å–∏
curl -X POST http://backend:8010/billing/subscribe \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"plan": "premium"}'

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î:
psql -c "SELECT COUNT(*) FROM proxies WHERE user_id = 'USER_UUID'"
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: 100

# ‚ú® –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–±–∏–≤–∫—É –ø–æ –º–æ–¥—É–ª—è–º:
psql -c "
SELECT
    module,
    COUNT(*) as proxy_count
FROM proxies
WHERE user_id = 'USER_UUID'
GROUP BY module
ORDER BY module;
"

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
#  module   | proxy_count
# ----------+-------------
#  demper   | 70
#  orders   | 25
#  catalog  | 5

# 3. –¢–µ—Å—Ç —Ä–æ—Ç–∞—Ü–∏–∏ –ø—Ä–æ–∫—Å–∏ (per-module)
async def test_rotation():
    # –¢–µ—Å—Ç –¥–µ–º–ø–µ—Ä –º–æ–¥—É–ª—è
    demper_rotator = ProxyRotator(user_id=test_user_id, module='demper')
    await demper_rotator.initialize()

    # –°–¥–µ–ª–∞—Ç—å 500 –∑–∞–ø—Ä–æ—Å–æ–≤
    for i in range(500):
        proxy = await demper_rotator.get_current_proxy()
        await demper_rotator.record_request(success=True)

        if i == 248:
            assert proxy.id == first_proxy_id
        if i == 249:
            # –î–æ–ª–∂–Ω–∞ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ —Ä–æ—Ç–∞—Ü–∏—è!
            assert proxy.id != first_proxy_id
            print(f"‚úÖ Demper proxy rotated at request #{i}")

# –ó–∞–ø—É—Å—Ç–∏—Ç—å:
python -m pytest tests/test_proxy_rotation.py -v

# 4. ‚ú® –¢–µ—Å—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –º–æ–¥—É–ª–µ–π (–ö–†–ò–¢–ò–ß–ù–û!)
async def test_concurrent_modules():
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–µ–º–ø–µ—Ä –∏ orders –Ω–µ –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—Ç –∑–∞ –ø—Ä–æ–∫—Å–∏
    """
    user_id = test_user_id

    # –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å:
    # - –¥–µ–º–ø–µ—Ä (650 –∑–∞–ø—Ä–æ—Å–æ–≤)
    # - orders (2 –∑–∞–ø—Ä–æ—Å–∞)

    async def demper_task():
        for i in range(650):
            rotator = await get_user_proxy_rotator(user_id, module='demper')
            proxy = await rotator.get_current_proxy()
            await rotator.record_request(success=True)
            print(f"Demper using proxy: {proxy.id}")

    async def orders_task():
        for i in range(2):
            rotator = await get_user_proxy_rotator(user_id, module='orders')
            proxy = await rotator.get_current_proxy()
            await rotator.record_request(success=True)
            print(f"Orders using proxy: {proxy.id}")

    # –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    start = time.time()
    await asyncio.gather(demper_task(), orders_task())
    elapsed = time.time() - start

    print(f"‚úÖ Concurrent execution completed in {elapsed:.1f}s")
    print("‚úÖ –î–µ–º–ø–µ—Ä –∏ orders –ù–ï –∂–¥–∞–ª–∏ –¥—Ä—É–≥ –¥—Ä—É–≥–∞ (—Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–∫—Å–∏ –ø—É–ª—ã)")

# –ó–∞–ø—É—Å—Ç–∏—Ç—å:
python -m pytest tests/test_concurrent_modules.py -v
Phase 5: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

# 1. Health endpoint
curl http://backend:8010/health/proxies

# –û–∂–∏–¥–∞–µ–º—ã–π JSON:
{
  "proxy_pool": {
    "total": 500,
    "available": 400,
    "allocated": 100,
    "resting": 0,
    "dead": 0
  },
  "users_with_proxies": 1,
  "average_proxies_per_user": 100,
  "per_module_allocation": {
    "demper": 70,
    "orders": 25,
    "catalog": 5
  }
}

# 2. –õ–æ–≥–∏ –ø—Ä–æ–∫—Å–∏-—Ä–æ—Ç–∞—Ü–∏–∏
railway logs -s backemd | grep "Proxy rotated"

# –û–∂–∏–¥–∞–µ—Ç—Å—è:
# [Worker-0] Proxy 12345 rotated after 249 requests (resting 40min)
# [Worker-0] Switched to proxy 67890

-- 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
SELECT
    p.host,
    u.requests_made,
    u.success_count,
    u.failure_count,
    (u.success_count::float / u.requests_made * 100) as success_rate
FROM proxy_usage_log u
JOIN proxies p ON p.id = u.proxy_id
WHERE u.started_at > NOW() - INTERVAL '1 hour'
ORDER BY u.started_at DESC
LIMIT 10;

-- –û–∂–∏–¥–∞–µ—Ç—Å—è: success_rate > 90% –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞
Phase 6: Production —Ç–µ—Å—Ç

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–º–ø–∏–Ω–≥ –¥–ª—è —é–∑–µ—Ä–∞ —Å 500 —Ç–æ–≤–∞—Ä–∞–º–∏
# –û—Ç—Å–ª–µ–¥–∏—Ç—å:

import time

start = time.time()

# –¢—Ä–∏–≥–≥–µ—Ä –¥–µ–º–ø–∏–Ω–≥–∞
await demper_worker.run_cycle()

elapsed = time.time() - start

print(f"‚úÖ –î–µ–º–ø–∏–Ω–≥ 500 —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞ {elapsed:.1f}s")

# –û–∂–∏–¥–∞–µ—Ç—Å—è: 60-120 —Å–µ–∫—É–Ω–¥ (2 –º–∏–Ω—É—Ç—ã)
# –ë–ï–ó –ø—Ä–æ–∫—Å–∏ –±—ã–ª–æ –±—ã: 500 —Ç–æ–≤–∞—Ä–æ–≤ / 8.33 req/min = 60 –º–∏–Ω—É—Ç!

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–µ—Ç 429 –æ—à–∏–±–æ–∫
railway logs -s backemd | grep "429"
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç–æ!

railway logs -s backemd | grep "Too Many Requests"
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç–æ!

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ü–µ–Ω—ã –æ–±–Ω–æ–≤–∏–ª–∏—Å—å
SELECT
    COUNT(*) as products_updated,
    MAX(updated_at) as last_update
FROM products
WHERE user_id = 'TEST_USER_ID'
  AND updated_at > NOW() - INTERVAL '5 minutes';

-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: products_updated = 500, last_update ~ NOW()

# ‚ú® –¢–µ—Å—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –¥–µ–º–ø–µ—Ä–∞ –∏ orders (–ö–†–ò–¢–ò–ß–ù–´–ô!)
async def test_concurrent_demper_and_orders():
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–µ–º–ø–µ—Ä (650 –∑–∞–ø—Ä–æ—Å–æ–≤) –∏ orders (2 –∑–∞–ø—Ä–æ—Å–∞)
    —Ä–∞–±–æ—Ç–∞—é—Ç –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–æ–∫—Å–∏ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è
    """
    user_id = test_user_id

    async def run_demper():
        """–°–∏–º—É–ª—è—Ü–∏—è –¥–µ–º–ø–µ—Ä–∞ - 650 –∑–∞–ø—Ä–æ—Å–æ–≤"""
        start = time.time()
        for i in range(650):
            await parse_product_by_sku(
                product_sku=f"test-sku-{i}",
                user_id=user_id,
                use_proxy=True
            )
        elapsed = time.time() - start
        print(f"Demper completed 650 requests in {elapsed:.1f}s")
        return elapsed

    async def run_orders():
        """–°–∏–º—É–ª—è—Ü–∏—è orders worker - 2 –∑–∞–ø—Ä–æ—Å–∞"""
        start = time.time()
        await asyncio.sleep(0.5)  # –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∑–∂–µ
        for i in range(2):
            rotator = await get_user_proxy_rotator(user_id, module='orders')
            proxy = await rotator.get_current_proxy()
            # –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ orders API
            await http_client.get(
                "https://kaspi.kz/shop/api/v2/orders",
                proxies={f"{proxy.protocol}://": f"{proxy.username}:{proxy.password}@{proxy.host}:{proxy.port}"}
            )
            await rotator.record_request(success=True)
        elapsed = time.time() - start
        print(f"Orders completed 2 requests in {elapsed:.1f}s")
        return elapsed

    # –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    global_start = time.time()
    demper_time, orders_time = await asyncio.gather(run_demper(), run_orders())
    global_elapsed = time.time() - global_start

    # –ü—Ä–æ–≤–µ—Ä–∫–∏:
    assert orders_time < 5, "Orders –¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –∑–∞ < 5 —Å–µ–∫ (–Ω–µ –∂–¥–∞–ª –¥–µ–º–ø–µ—Ä–∞!)"
    assert demper_time < 120, "Demper –¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –∑–∞ < 2 –º–∏–Ω—É—Ç—ã"
    assert global_elapsed < max(demper_time, orders_time) + 5, "–†–∞–±–æ—Ç–∞–ª–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ"

    print(f"""
    ‚úÖ –¢–µ—Å—Ç –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ!
    - Demper: {demper_time:.1f}s (650 –∑–∞–ø—Ä–æ—Å–æ–≤)
    - Orders: {orders_time:.1f}s (2 –∑–∞–ø—Ä–æ—Å–∞)
    - Total: {global_elapsed:.1f}s
    - Orders –ù–ï –∂–¥–∞–ª –¥–µ–º–ø–µ—Ä–∞! (—Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–∫—Å–∏ –ø—É–ª—ã)
    """)

# –ó–∞–ø—É—Å—Ç–∏—Ç—å:
python -m pytest tests/test_production_concurrent.py -v

-- ‚ú® –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–æ–∫—Å–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
SELECT
    p.module,
    COUNT(DISTINCT p.id) as unique_proxies_used,
    SUM(p.requests_count) as total_requests
FROM proxies p
WHERE p.user_id = 'TEST_USER_ID'
  AND p.last_used_at > NOW() - INTERVAL '10 minutes'
GROUP BY p.module
ORDER BY p.module;

-- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
--  module  | unique_proxies_used | total_requests
-- ---------+---------------------+----------------
--  demper  | 3                   | 650            (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª 3 –ø—Ä–æ–∫—Å–∏)
--  orders  | 1                   | 2              (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª 1 –ø—Ä–æ–∫—Å–∏)
--
-- ‚úÖ –ü—Ä–æ–∫—Å–∏ –ù–ï –ø–µ—Ä–µ—Å–µ–∫–∞–ª–∏—Å—å –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏!
–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è
üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï –†–ò–°–ö–ò
–†–∏—Å–∫	–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å	–í–ª–∏—è–Ω–∏–µ	–ú–∏—Ç–∏–≥–∞—Ü–∏—è
–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—Å–∫–∏–µ IPv6 –ù–ï —Ä–∞–±–æ—Ç–∞—é—Ç —Å Kaspi	60%	–ë–õ–û–ö–ï–†	Phase 0: —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ! –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç ‚Üí KZ residential
Kaspi –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ–∫—Å–∏ –ø–æ fingerprint	40%	–í—ã—Å–æ–∫–æ–µ	–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Playwright —Å real browser fingerprint
Kaspi –±–∞–Ω–∏—Ç –≤–µ—Å—å subnet –ø—Ä–æ–∫—Å–∏	30%	–í—ã—Å–æ–∫–æ–µ	–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å residential (—Ä–æ—Ç–∏—Ä—É—é—Ç IP), –Ω–µ datacenter
Proxy6.net –ø—Ä–æ–∫—Å–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ	50%	–°—Ä–µ–¥–Ω–µ–µ	Health checks, auto-replace dead proxies, —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
üü† –í–´–°–û–ö–ò–ï –†–ò–°–ö–ò
–†–∏—Å–∫	–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å	–í–ª–∏—è–Ω–∏–µ	–ú–∏—Ç–∏–≥–∞—Ü–∏—è
–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ (–Ω–∞—Ä—É—à–µ–Ω–∏–µ ToS Kaspi)	90%	–°—Ä–µ–¥–Ω–µ–µ	Disclaimer –≤ UI: "–ù–∞ –≤–∞—à —Ä–∏—Å–∫". –ù–µ –∞—Ñ–∏—à–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥.
–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏ —Ä–∞—Å—Ç–µ—Ç	40%	–°—Ä–µ–¥–Ω–µ–µ	–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–Ω, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ —Ä–æ—Å—Ç–µ > 20%
Proxy pool –∏—Å—Ç–æ—â–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ	30%	–°—Ä–µ–¥–Ω–µ–µ	–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–∫—É–ø–∫–∞, –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ < 100 available
–ü—Ä–æ–∫—Å–∏ —é–∑–µ—Ä–∞ –≤—Å–µ —É–º–µ—Ä–ª–∏	20%	–í—ã—Å–æ–∫–æ–µ	Auto-replacement: –µ—Å–ª–∏ dead > 20% ‚Üí –∑–∞–∫—É–ø–∏—Ç—å –Ω–æ–≤—ã–µ
üü° –°–†–ï–î–ù–ò–ï –†–ò–°–ö–ò
–†–∏—Å–∫	–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å	–í–ª–∏—è–Ω–∏–µ	–ú–∏—Ç–∏–≥–∞—Ü–∏—è
Kaspi –∏–∑–º–µ–Ω–∏—Ç API	30%	–í—ã—Å–æ–∫–æ–µ	–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, fallback
–õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏	60%	–ù–∏–∑–∫–æ–µ	–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–∫—Å–∏ (< 300ms ping)
Memory leak –≤ ProxyRotator	20%	–°—Ä–µ–¥–Ω–µ–µ	–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π restart –≤–æ—Ä–∫–µ—Ä–æ–≤ (–∫–∞–∂–¥—ã–µ 24—á)
–í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è
1. ‚ö†Ô∏è –í—ã–±–æ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø—Ä–æ–∫—Å–∏
–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—Å–∫–∏–µ IPv6 ($11/100 –ø—Ä–æ–∫—Å–∏):

‚úÖ –î–µ—à–µ–≤–æ
‚úÖ IPv6 = –±–æ–ª—å—à–µ IP –∞–¥—Ä–µ—Å–æ–≤
‚ùå Kaspi –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–µ-KZ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
‚ùå IPv6 adoption –Ω–∏–∑–∫–∏–π –≤ KZ (~5-10%)
–†–∏—Å–∫: 60% —á—Ç–æ –ù–ï –ë–£–î–£–¢ —Ä–∞–±–æ—Ç–∞—Ç—å
–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–µ Residential ($100-150/100 –ø—Ä–æ–∫—Å–∏):

‚úÖ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è (Kaspi –Ω–µ –∑–∞–ø–æ–¥–æ–∑—Ä–∏—Ç)
‚úÖ Residential IP (–≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ —é–∑–µ—Ä—ã)
‚úÖ IPv4 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –≤ KZ)
‚ùå –î–æ—Ä–æ–≥–æ (10x –¥–æ—Ä–æ–∂–µ)
–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—Å–ª–∏ NL –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
–í–ê–ñ–ù–û: Phase 0 —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!

2. üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏ credentials

# –í –ë–î –ø—Ä–æ–∫—Å–∏ –ø–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ!
# –î–ª—è production –Ω—É–∂–Ω–æ:

1. –®–∏—Ñ—Ä–æ–≤–∞—Ç—å –≤ –ë–î (AES-256)
2. –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—Ç—å –≤ –ø–∞–º—è—Ç–∏ worker'–∞
3. –ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å credentials

# app/core/security.py
def encrypt_proxy_password(password: str) -> str:
    """Encrypt proxy password before storing in DB"""
    return cipher.encrypt(password.encode()).decode()

def decrypt_proxy_password(encrypted: str) -> str:
    """Decrypt proxy password when loading from DB"""
    return cipher.decrypt(encrypted.encode()).decode()
3. üìä –°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏ –Ω–∞ —é–∑–µ—Ä–∞
–ü—Ä–æ–∫—Å–∏: $11 / 100 –ø—Ä–æ–∫—Å–∏ / 30 –¥–Ω–µ–π

–ù–∞ –æ–¥–Ω–æ–≥–æ —é–∑–µ—Ä–∞:

100 –ø—Ä–æ–∫—Å–∏ √ó $11 / 100 = $11/–º–µ—Å—è—Ü
