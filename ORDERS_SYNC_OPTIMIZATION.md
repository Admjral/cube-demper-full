# Orders Sync Optimization ‚Äî Faster Polling

## ‚ö°Ô∏è –ò–∑–º–µ–Ω–µ–Ω–∏—è

### **–ë—ã–ª–æ (60 –º–∏–Ω—É—Ç)**
- `SYNC_INTERVAL = 3600` (60 –º–∏–Ω—É—Ç)
- `STORE_DELAY = 2.0` —Å–µ–∫—É–Ω–¥—ã
- `Semaphore(5)` ‚Äî 5 –º–∞–≥–∞–∑–∏–Ω–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- **–ù–µ—Ç rate limiting** –¥–ª—è Orders API
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: ~53 –º–∏–Ω –Ω–∞ —Ü–∏–∫–ª –∏–∑ 400 –º–∞–≥–∞–∑–∏–Ω–æ–≤

### **–°—Ç–∞–ª–æ (8 –º–∏–Ω—É—Ç)** ‚úÖ
- `SYNC_INTERVAL = 480` (8 –º–∏–Ω—É—Ç)
- `STORE_DELAY = 0.3` —Å–µ–∫—É–Ω–¥—ã
- `Semaphore(12)` ‚Äî 12 –º–∞–≥–∞–∑–∏–Ω–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- **Rate limiting 6 RPS** –¥–ª—è –≤—Å–µ—Ö Orders API –∑–∞–ø—Ä–æ—Å–æ–≤
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: ~7-8 –º–∏–Ω –Ω–∞ —Ü–∏–∫–ª –∏–∑ 400 –º–∞–≥–∞–∑–∏–Ω–æ–≤

---

## üìä –†–∞—Å—á–µ—Ç—ã (–Ω–∞ –æ—Å–Ω–æ–≤–µ rate-limits-test-results.md)

### –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ü–∏–∫–ª:
- **400 –º–∞–≥–∞–∑–∏–Ω–æ–≤**
- **–°—Ä–µ–¥–Ω–∏–π –º–∞–≥–∞–∑–∏–Ω**: 15 –∑–∞–ø—Ä–æ—Å–æ–≤ (4 tabs + 10-15 order details)
- **–ò—Ç–æ–≥–æ**: 400 √ó 15 = **6,000 –∑–∞–ø—Ä–æ—Å–æ–≤**

### Rate Limit (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π):
- **6 RPS** –¥–ª—è MC GraphQL + REST API
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –æ–±–æ–∏—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- –ó–∞–ø–∞—Å –æ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ ~10 RPS

### –í—Ä–µ–º—è —Ü–∏–∫–ª–∞:
- **–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ**: 6,000 / 6 = 1,000 —Å–µ–∫ = 16.7 –º–∏–Ω
- **–° –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–æ–º (12 –º–∞–≥–∞–∑–∏–Ω–æ–≤)**: ~7-8 –º–∏–Ω ‚úÖ
- **–ò–Ω—Ç–µ—Ä–≤–∞–ª**: 8 –º–∏–Ω—É—Ç –º–µ–∂–¥—É —Ü–∏–∫–ª–∞–º–∏
- **Margin**: 0-1 –º–∏–Ω—É—Ç–∞ –º–µ–∂–¥—É —Ü–∏–∫–ª–∞–º–∏

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ë—ã—Å—Ç—Ä–µ–µ –≤ 7.5 —Ä–∞–∑**: 60 –º–∏–Ω ‚Üí 8 –º–∏–Ω
2. **–ü–æ—á—Ç–∏ real-time**: –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã ‚Üí WhatsApp —á–µ—Ä–µ–∑ 8 –º–∏–Ω (–≤ —Å—Ä–µ–¥–Ω–µ–º 4 –º–∏–Ω)
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ**: rate limiting 6 RPS –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–∞–Ω–æ–≤
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è**: –ø—Ä–∏ —Ä–æ—Å—Ç–µ –¥–æ 1000 –º–∞–≥–∞–∑–∏–Ω–æ–≤ ‚Üí ~18 –º–∏–Ω —Ü–∏–∫–ª (–≤—Å—ë –µ—â—ë <20 –º–∏–Ω)

---

## üîß –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **new-backend/app/services/orders_sync_service.py**
   - `SYNC_INTERVAL = 480` (8 –º–∏–Ω—É—Ç)
   - `STORE_DELAY = 0.3` (–º–µ–∂–¥—É –º–∞–≥–∞–∑–∏–Ω–∞–º–∏)
   - `MAX_CONCURRENT_STORES = 12` (Semaphore)

2. **new-backend/app/core/rate_limiter.py**
   - –î–æ–±–∞–≤–ª–µ–Ω `get_orders_rate_limiter()` ‚Üí 6 RPS

3. **new-backend/app/services/kaspi_mc_service.py**
   - Rate limiting –ø–µ—Ä–µ–¥ MC GraphQL –∑–∞–ø—Ä–æ—Å–∞–º–∏ (tabs + orderDetail)

4. **new-backend/app/services/kaspi_orders_api.py**
   - Rate limiting –ø–µ—Ä–µ–¥ REST API –∑–∞–ø—Ä–æ—Å–∞–º–∏

---

## ‚úÖ Verification

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
```bash
docker logs cube-demper-backend-1 --tail 100 | grep ORDERS_SYNC
```

**–û–∂–∏–¥–∞–µ–º—ã–π output:**
```
[ORDERS_SYNC] Starting periodic orders sync (interval: 480s)
[ORDERS_SYNC] Starting cycle for 400 stores
[ORDERS_SYNC] Store "Example": 5 orders (3 new, 2 updated)
...
[ORDERS_SYNC] Cycle complete in 450s: 400 stores, 1234 orders synced
[ORDERS_SYNC] Next cycle in 480s
```

---

## üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ (60 –º–∏–Ω) | –ü–æ—Å–ª–µ (8 –º–∏–Ω) | –ü—Ä–∏—Ä–æ—Å—Ç |
|---------|-------------|---------------|---------|
| –ò–Ω—Ç–µ—Ä–≤–∞–ª —Ü–∏–∫–ª–∞ | 60 –º–∏–Ω | 8 –º–∏–Ω | **7.5x** |
| –í—Ä–µ–º—è –¥–æ WhatsApp (—Å—Ä–µ–¥–Ω–µ–µ) | 30 –º–∏–Ω | 4 –º–∏–Ω | **7.5x** |
| –ó–∞–∫–∞–∑–æ–≤ –≤ —á–∞—Å | 400 √ó 5 = 2,000 | 400 √ó 5 √ó 7 = 14,000 | **7x** |
| Concurrency | 5 –º–∞–≥–∞–∑–∏–Ω–æ–≤ | 12 –º–∞–≥–∞–∑–∏–Ω–æ–≤ | **2.4x** |
| Rate limit | –ù–µ—Ç | 6 RPS | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |

---

## üöÄ –î–∞—Ç–∞ –¥–µ–ø–ª–æ—è: 2026-02-12
