# –ü–ª–∞–Ω: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Feature Gates ‚Äî –ê–Ω–∞–ª–∏–∑ –∏ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–í –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å —Å–∏—Å—Ç–µ–º–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ –∏ feature gates –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –ø–æ –ø–æ–¥–ø–∏—Å–∫–∞–º, –Ω–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ endpoints –ù–ï –∑–∞—â–∏—â–µ–Ω—ã feature gates. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ **–±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–ø–ª–∞—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**.

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–æ 12 —Ñ–∏—á** –≤ `FeatureAccessService.FEATURE_REQUIREMENTS`
- **–ó–∞—â–∏—â–µ–Ω–æ —Ç–æ–ª—å–∫–æ 2 endpoint'a**: `POST /ai/salesman/process-order`, `POST /ai/salesman/process-bulk`
- **197 endpoints –≤—Å–µ–≥–æ**, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö ~15-20 –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—â–∏—â–µ–Ω—ã feature gates

### –¢–∞—Ä–∏—Ñ–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–∏–∑ tariffs_cube_demper.md)

| –ü–ª–∞–Ω | –¶–µ–Ω–∞ | –§—É–Ω–∫—Ü–∏–∏ |
|------|------|---------|
| **21,990 —Ç–≥** (Basic) | 21,990 | –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ 500, –î–µ–º–ø–∏–Ω–≥ 50, –ù–µ –∫–æ–Ω–∫—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ —Å–≤–æ–∏–º–∏, –°–∫–ª–µ–π–∫–∞ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö, –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏, –Æ–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∞, –ò–ò —é—Ä–∏—Å—Ç, –ü–æ–¥–¥–µ—Ä–∂–∫–∞ |
| **27,990 —Ç–≥** (Standard) | 27,990 | –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ 1000, –î–µ–º–ø–∏–Ω–≥ 100, –î–µ–º–ø–µ—Ä –ø–æ –≥–æ—Ä–æ–¥–∞–º, –ü—Ä–µ–¥–∑–∞–∫–∞–∑, –ü–æ–∏—Å–∫ –Ω–∏—à, –ê–≤—Ç–æ —Ä–∞—Å—Å—ã–ª–∫–∞, + –≤—Å–µ –∏–∑ Basic |
| **33,990 —Ç–≥** (Premium) | 33,990 | –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–µ–∑–ª–∏–º–∏—Ç, –î–µ–º–ø–∏–Ω–≥ 200, –î–µ–º–ø–µ—Ä –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ, –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã, –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞, + –≤—Å–µ –∏–∑ Standard |

**–û—Ç–¥–µ–ª—å–Ω—ã–µ –∞–¥–¥–æ–Ω—ã:**
- –ò–ò –ø—Ä–æ–¥–∞–∂–Ω–∏–∫: 15,000
- –î–µ–º–ø–∏–Ω–≥ +100 —Ç–æ–≤–∞—Ä–æ–≤: 10,000
- –ü—Ä–µ–¥–∑–∞–∫–∞–∑: 10,000
- WhatsApp —Ä–∞—Å—Å—ã–ª–∫–∞: 15,000
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–µ–∑–ª–∏–º–∏—Ç: 20,000
- –î–µ–º–ø–µ—Ä –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ: 10,000
- –î–µ–º–ø–µ—Ä –ø–æ –≥–æ—Ä–æ–¥–∞–º: 10,000

---

## –ü—Ä–æ–±–ª–µ–º—ã

### 1. Feature gates –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã, –Ω–æ –ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è

| –§–∏—á–∞ | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –î–æ–ª–∂–Ω–∞ –∑–∞—â–∏—â–∞—Ç—å |
|------|-----------|--------------|-----------------|
| `analytics` | ‚úÖ | ‚ùå | Kaspi analytics endpoints |
| `demping` | ‚úÖ | ‚ùå | Demping run endpoints |
| `ai_lawyer` | ‚úÖ | ‚ùå | Lawyer chat, calculators, documents |
| `preorder` | ‚úÖ | ‚ùå | Preorders CRUD |
| `whatsapp_auto` | ‚úÖ | ‚ùå | WhatsApp templates, auto-messages |
| `whatsapp_bulk` | ‚úÖ | ‚ùå | WhatsApp broadcasts |
| `unit_economics` | ‚úÖ | ‚ùå | Unit economics calculator |
| `invoice_glue` | ‚úÖ | ‚ùå | Invoice PDF merge |
| `orders_view` | ‚úÖ | ‚ùå | Orders customer phone |
| `exclude_own_stores` | ‚úÖ | ‚ùå | Analytics exclude own stores |
| `priority_support` | ‚úÖ | ‚ùå | Support priority flag |

### 2. –§—É–Ω–∫—Ü–∏–∏ –∏–∑ —Ç–∞—Ä–∏—Ñ–æ–≤ –ë–ï–ó —Ñ–∏—á

| –§—É–Ω–∫—Ü–∏—è –∏–∑ —Ç–∞—Ä–∏—Ñ–∞ | –§–∏—á–∞ –≤ –∫–æ–¥–µ | –°—Ç–∞—Ç—É—Å |
|-------------------|-------------|--------|
| –ü–æ–∏—Å–∫ –Ω–∏—à | ‚ùå –ù–ï–¢ | Endpoints –æ—Ç–∫—Ä—ã—Ç—ã –≤—Å–µ–º |
| –î–µ–º–ø–µ—Ä –ø–æ –≥–æ—Ä–æ–¥–∞–º | ‚ùå –ù–ï–¢ | Endpoints –æ—Ç–∫—Ä—ã—Ç—ã –≤—Å–µ–º |
| –î–µ–º–ø–µ—Ä –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ | ‚ùå –ù–ï–¢ | Endpoint –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç? |
| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã | ‚ùå –ù–ï–¢ | Endpoint –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç? |

### 3. Endpoints –ë–ï–ó feature gates (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ)

#### AI Lawyer (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Basic+)
- `POST /lawyer/chat` - –≥–ª–∞–≤–Ω—ã–π endpoint
- `POST /lawyer/generate-document`
- `POST /lawyer/calculate-penalty`
- `POST /lawyer/calculate-tax`
- `POST /lawyer/calculate-fee`
- `POST /lawyer/analyze-contract`

**–ü—Ä–æ–±–ª–µ–º–∞**: –õ—é–±–æ–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ò–ò —é—Ä–∏—Å—Ç–æ–º! Gemini API —Å—Ç–æ–∏—Ç –¥–µ–Ω–µ–≥.

#### Preorders (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Standard+ –∏–ª–∏ addon)
- `GET /preorders/`
- `POST /preorders/`
- `PATCH /preorders/{id}`
- `DELETE /preorders/{id}`

#### Unit Economics (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Basic+)
- `POST /unit-economics/calculate`
- `POST /unit-economics/parse-url`
- `GET /unit-economics/saved`

#### Invoices (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Basic+)
- `POST /invoices/process-invoices`

#### Niches (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Standard+)
- `GET /niches/categories`
- `GET /niches/products`
- `POST /niches/calculate-unit-economics`

#### WhatsApp (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Standard+ –∏–ª–∏ addon)
–í—Å–µ ~30 endpoints –æ—Ç–∫—Ä—ã—Ç—ã! –õ—é–±–æ–π –º–æ–∂–µ—Ç:
- –°–æ–∑–¥–∞–≤–∞—Ç—å —Å–µ—Å—Å–∏–∏
- –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
- –î–µ–ª–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω—ã

---

## –õ–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π

### Free –ø–ª–∞–Ω (plan_id = NULL)
**–î–æ—Å—Ç—É–ø:**
- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- ‚úÖ Support chat
- ‚úÖ Billing info (–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–ª–∞–Ω–æ–≤)
- ‚úÖ Notifications

**–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ:**
- ‚ùå –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ

### Basic –ø–ª–∞–Ω (21,990 —Ç–≥)
**–ë–∞–∑–æ–≤—ã–µ —Ñ–∏—á–∏:**
- `analytics` (–ª–∏–º–∏—Ç 500)
- `demping` (–ª–∏–º–∏—Ç 50)
- `exclude_own_stores`
- `invoice_glue`
- `orders_view`
- `unit_economics`
- `ai_lawyer`
- `priority_support`

### Standard –ø–ª–∞–Ω (27,990 —Ç–≥)
**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ Basic:**
- `preorder`
- `whatsapp_auto`
- `niche_search`
- `city_demping`

### Premium –ø–ª–∞–Ω (33,990 —Ç–≥)
**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ Standard:**
- `whatsapp_bulk`
- `delivery_demping` (–µ—Å–ª–∏ –µ—Å—Ç—å)
- `priority_products` (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ unlimited

### –ê–¥–¥–æ–Ω—ã (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø–ª–∞–Ω–∞)
- `ai_salesman` (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∞–¥–¥–æ–Ω!)
- `demping_addon` (+100 —Ç–æ–≤–∞—Ä–æ–≤)
- `analytics_unlimited`
- `city_demping` (–µ—Å–ª–∏ –Ω–µ—Ç Standard+)
- `delivery_demping`
- `whatsapp` (–µ—Å–ª–∏ –Ω–µ—Ç Standard+)
- `preorder` (–µ—Å–ª–∏ –Ω–µ—Ç Standard+)

---

## –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ñ–∏—á–∏

**–§–∞–π–ª:** `new-backend/app/services/feature_access.py`

**–î–æ–±–∞–≤–∏—Ç—å –≤ FEATURE_REQUIREMENTS:**
```python
FEATURE_REQUIREMENTS = {
    # ... existing features ...

    # –ù–æ–≤—ã–µ —Ñ–∏—á–∏:
    'niche_search': {'plans': ['standard', 'premium']},
    'city_demping': {'plans': ['standard', 'premium'], 'addons': ['city_demping']},
    'delivery_demping': {'plans': ['premium'], 'addons': ['delivery_demping']},
    'priority_products': {'plans': ['premium']},
}
```

### 2. –ó–∞—â–∏—Ç–∏—Ç—å AI Lawyer endpoints

**–§–∞–π–ª:** `new-backend/app/routers/lawyer.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
```python
# –î–û–ë–ê–í–ò–¢–¨ import
from ..dependencies import require_feature

# –ò–ó–ú–ï–ù–ò–¢–¨ –≤—Å–µ endpoint signatures:

# –ë–´–õ–û:
@router.post("/chat")
async def chat_with_lawyer(
    current_user: Annotated[dict, Depends(get_current_user)],
    # ...
):

# –°–¢–ê–õ–û:
@router.post("/chat")
async def chat_with_lawyer(
    current_user: Annotated[dict, require_feature("ai_lawyer")],  # ‚Üê FEATURE GATE
    # ...
):
```

**Endpoints –¥–ª—è –∑–∞—â–∏—Ç—ã:**
- `/chat`
- `/generate-document`
- `/analyze-contract`
- `/calculate-penalty`
- `/calculate-tax`
- `/calculate-fee`

### 3. –ó–∞—â–∏—Ç–∏—Ç—å Preorders endpoints

**–§–∞–π–ª:** `new-backend/app/routers/preorders.py`

**–î–æ–±–∞–≤–∏—Ç—å –∫ –∫–∞–∂–¥–æ–º—É endpoint:**
```python
current_user: Annotated[dict, require_feature("preorder")]
```

### 4. –ó–∞—â–∏—Ç–∏—Ç—å Unit Economics endpoints

**–§–∞–π–ª:** `new-backend/app/routers/unit_economics.py`

**Endpoints:**
- `POST /calculate`
- `POST /parse-url`
- `GET /saved`
- `POST /saved`
- `PUT /saved/{id}`
- `DELETE /saved/{id}`

### 5. –ó–∞—â–∏—Ç–∏—Ç—å Invoices endpoint

**–§–∞–π–ª:** `new-backend/app/routers/invoices.py`

```python
@router.post("/process-invoices")
async def process_invoices(
    current_user: Annotated[dict, require_feature("invoice_glue")],
    # ...
):
```

### 6. –ó–∞—â–∏—Ç–∏—Ç—å Niches endpoints

**–§–∞–π–ª:** `new-backend/app/routers/niches.py`

**–í—Å–µ endpoints:**
- `GET /categories`
- `GET /categories/{id}`
- `GET /products`
- `GET /products/{id}`
- `POST /calculate-unit-economics`
- `GET /stats`

**–î–æ–±–∞–≤–∏—Ç—å:**
```python
current_user: Annotated[dict, require_feature("niche_search")]
```

### 7. –ó–∞—â–∏—Ç–∏—Ç—å WhatsApp endpoints

**–§–∞–π–ª:** `new-backend/app/routers/whatsapp.py`

**–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ:**

#### Sessions, Messages, Templates ‚Üí `whatsapp_auto`
```python
# Sessions management
@router.post("/sessions")
async def create_session(
    current_user: Annotated[dict, require_feature("whatsapp_auto")],
    # ...
):

# Message sending
@router.post("/send")
async def send_message(
    current_user: Annotated[dict, require_feature("whatsapp_auto")],
    # ...
):

# Templates CRUD
@router.get("/templates")
async def list_templates(
    current_user: Annotated[dict, require_feature("whatsapp_auto")],
    # ...
):
```

#### Broadcasts ‚Üí `whatsapp_bulk`
```python
@router.post("/broadcasts")
async def create_broadcast(
    current_user: Annotated[dict, require_feature("whatsapp_bulk")],
    # ...
):

@router.post("/broadcasts/{id}/start")
async def start_broadcast(
    current_user: Annotated[dict, require_feature("whatsapp_bulk")],
    # ...
):
```

### 8. –ó–∞—â–∏—Ç–∏—Ç—å City Demping

**–§–∞–π–ª:** `new-backend/app/routers/kaspi.py`

**Endpoint:**
```python
@router.post("/products/{product_id}/run-city-demping")
async def run_city_demping(
    current_user: Annotated[dict, require_feature("city_demping")],
    # ...
):
```

### 9. –ó–∞—â–∏—Ç–∏—Ç—å Orders View

**–§–∞–π–ª:** `new-backend/app/routers/kaspi.py`

```python
@router.get("/orders/{store_id}/{order_code}/customer")
async def get_order_customer(
    current_user: Annotated[dict, require_feature("orders_view")],
    # ...
):
```

### 10. –ó–∞—â–∏—Ç–∏—Ç—å Analytics

**–§–∞–π–ª:** `new-backend/app/routers/kaspi.py`

**Endpoints:**
- `GET /analytics`
- `GET /stores/{store_id}/analytics`
- `GET /stores/{store_id}/stats`

```python
@router.get("/analytics")
async def get_analytics(
    current_user: Annotated[dict, require_feature("analytics")],
    # ...
):
```

### 11. –ó–∞—â–∏—Ç–∏—Ç—å Demping endpoints

**–§–∞–π–ª:** `new-backend/app/routers/kaspi.py`

**Endpoints:**
- `POST /products/{id}/run-demping`
- `POST /stores/{id}/run-demping`
- `POST /products/bulk-update` (–µ—Å–ª–∏ –≤–∫–ª—é—á–∞–µ—Ç –¥–µ–º–ø–∏–Ω–≥)

```python
@router.post("/products/{product_id}/run-demping")
async def run_demping(
    current_user: Annotated[dict, require_feature("demping")],
    # ...
):
```

---

## –ü–æ–ª–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ –∑–∞—â–∏—Ç—ã

| Router | Endpoints Count | Feature Gate | Priority |
|--------|----------------|--------------|----------|
| **lawyer.py** | 10 | `ai_lawyer` | üî¥ HIGH (Gemini costs!) |
| **preorders.py** | 4 | `preorder` | üî¥ HIGH |
| **unit_economics.py** | 6 | `unit_economics` | üî¥ HIGH |
| **invoices.py** | 1 | `invoice_glue` | üü° MEDIUM |
| **niches.py** | 6 | `niche_search` (new) | üî¥ HIGH |
| **whatsapp.py** | ~25 | `whatsapp_auto` / `whatsapp_bulk` | üî¥ HIGH (WAHA costs!) |
| **kaspi.py** (analytics) | 3 | `analytics` | üü° MEDIUM |
| **kaspi.py** (demping) | 3 | `demping` | üü° MEDIUM |
| **kaspi.py** (orders) | 1 | `orders_view` | üü¢ LOW |
| **kaspi.py** (city demping) | 1 | `city_demping` (new) | üü¢ LOW |

**–ò—Ç–æ–≥–æ:** ~60 endpoints –Ω—É–∂–¥–∞—é—Ç—Å—è –≤ –∑–∞—â–∏—Ç–µ feature gates

---

## –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `services/feature_access.py` | –î–æ–±–∞–≤–∏—Ç—å 4 –Ω–æ–≤—ã—Ö —Ñ–∏—á–∏ (niche_search, city_demping, delivery_demping, priority_products) |
| `routers/lawyer.py` | –î–æ–±–∞–≤–∏—Ç—å feature gates –∫ 10 endpoints |
| `routers/preorders.py` | –î–æ–±–∞–≤–∏—Ç—å feature gates –∫ 4 endpoints |
| `routers/unit_economics.py` | –î–æ–±–∞–≤–∏—Ç—å feature gates –∫ 6 endpoints |
| `routers/invoices.py` | –î–æ–±–∞–≤–∏—Ç—å feature gate –∫ 1 endpoint |
| `routers/niches.py` | –î–æ–±–∞–≤–∏—Ç—å feature gates –∫ 6 endpoints |
| `routers/whatsapp.py` | –î–æ–±–∞–≤–∏—Ç—å feature gates –∫ ~25 endpoints (—Ä–∞–∑–¥–µ–ª–∏—Ç—å auto/bulk) |
| `routers/kaspi.py` | –î–æ–±–∞–≤–∏—Ç—å feature gates –∫ ~8 endpoints (analytics, demping, orders, city) |

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ (Verification)

### 1. –¢–µ—Å—Ç —Å Free –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
```bash
# 1. –°–æ–∑–¥–∞—Ç—å free –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
# 2. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤—ã–∑–≤–∞—Ç—å –∑–∞—â–∏—â—ë–Ω–Ω—ã–π endpoint

curl -X POST https://cube-demper.shop/api/lawyer/chat \
  -H "Authorization: Bearer {free_user_token}" \
  -H "Content-Type: application/json" \
  -d '{"message": "test"}'

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
{
  "detail": {
    "error": "feature_not_available",
    "feature": "ai_lawyer",
    "message": "–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Ç–∞—Ä–∏—Ñ–µ –ë–∞–∑–æ–≤—ã–π"
  }
}
```

### 2. –¢–µ—Å—Ç —Å Basic –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
```bash
# 1. –°–æ–∑–¥–∞—Ç—å basic –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
# 2. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å ai_lawyer (–¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å)

curl -X POST https://cube-demper.shop/api/lawyer/chat \
  -H "Authorization: Bearer {basic_user_token}" \
  -H "Content-Type: application/json" \
  -d '{"message": "test"}'

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: 200 OK, –æ—Ç–≤–µ—Ç –æ—Ç AI Lawyer

# 3. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å preorder (–ù–ï –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å)
curl -X GET https://cube-demper.shop/api/preorders \
  -H "Authorization: Bearer {basic_user_token}"

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: 403 Forbidden
{
  "detail": {
    "error": "feature_not_available",
    "feature": "preorder",
    "message": "–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Ç–∞—Ä–∏—Ñ–µ –°—Ç–∞–Ω–¥–∞—Ä—Ç –ª–∏–±–æ –¥–æ–ø. —É—Å–ª—É–≥–µ ¬´–ü—Ä–µ–¥–∑–∞–∫–∞–∑¬ª"
  }
}
```

### 3. –¢–µ—Å—Ç –ª–∏–º–∏—Ç–æ–≤
```bash
# Analytics limit –¥–ª—è Basic = 100 —Ç–æ–≤–∞—Ä–æ–≤
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ—Å–ª–µ 100 —Ç–æ–≤–∞—Ä–æ–≤:
# - Analytics endpoints –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ—à–∏–±–∫—É "–õ–∏–º–∏—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω (100/100)"
# - –ü—Ä–µ–¥–ª–∞–≥–∞—é—Ç –∫—É–ø–∏—Ç—å –∞–¥–¥–æ–Ω –∏–ª–∏ –ø–æ–≤—ã—Å–∏—Ç—å —Ç–∞—Ä–∏—Ñ
```

### 4. –¢–µ—Å—Ç –∞–¥–¥–æ–Ω–æ–≤
```bash
# 1. Free –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫—É–ø–∞–µ—Ç –∞–¥–¥–æ–Ω "ai_salesman"
# 2. –î–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –¢–û–õ–¨–ö–û –∫ AI Salesman, –Ω–æ –Ω–µ –∫ –¥—Ä—É–≥–∏–º —Ñ–∏—á–∞–º

curl -X POST https://cube-demper.shop/api/ai/salesman/process-order \
  -H "Authorization: Bearer {free_with_ai_salesman_token}"

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: 200 OK

curl -X POST https://cube-demper.shop/api/lawyer/chat \
  -H "Authorization: Bearer {free_with_ai_salesman_token}"

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: 403 Forbidden (–Ω–µ—Ç ai_lawyer feature)
```

---

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### Phase 1: Critical (HIGH priority)
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å 4 –Ω–æ–≤—ã—Ö —Ñ–∏—á–∏ –≤ `feature_access.py`
2. ‚úÖ –ó–∞—â–∏—Ç–∏—Ç—å `lawyer.py` (10 endpoints)
3. ‚úÖ –ó–∞—â–∏—Ç–∏—Ç—å `niches.py` (6 endpoints)
4. ‚úÖ –ó–∞—â–∏—Ç–∏—Ç—å `whatsapp.py` (~25 endpoints)

### Phase 2: Medium priority
5. ‚úÖ –ó–∞—â–∏—Ç–∏—Ç—å `preorders.py` (4 endpoints)
6. ‚úÖ –ó–∞—â–∏—Ç–∏—Ç—å `unit_economics.py` (6 endpoints)
7. ‚úÖ –ó–∞—â–∏—Ç–∏—Ç—å `invoices.py` (1 endpoint)

### Phase 3: LOW priority (–º–æ–∂–µ—Ç –ø–æ–¥–æ–∂–¥–∞—Ç—å)
8. ‚úÖ –ó–∞—â–∏—Ç–∏—Ç—å `kaspi.py` analytics (3 endpoints)
9. ‚úÖ –ó–∞—â–∏—Ç–∏—Ç—å `kaspi.py` demping (3 endpoints)
10. ‚úÖ –ó–∞—â–∏—Ç–∏—Ç—å `kaspi.py` orders/city (2 endpoints)

### Phase 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
11. ‚úÖ End-to-end —Ç–µ—Å—Ç—ã –≤—Å–µ—Ö feature gates
12. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ (analytics_limit, demping_limit)
13. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–¥–æ–Ω–æ–≤

---

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. Webhook endpoints –ë–ï–ó feature gates
`POST /whatsapp/webhook` ‚Äî –ù–ï –∑–∞—â–∏—â–∞—Ç—å! –≠—Ç–æ callback –æ—Ç WAHA, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### 2. –ü—É–±–ª–∏—á–Ω—ã–µ endpoints
- `GET /billing/plans`
- `GET /billing/plans-v2`
- `GET /billing/addons`
- `GET /health/*`
- `POST /auth/register`
- `POST /auth/login`

–ù–ï –∑–∞—â–∏—â–∞—Ç—å feature gates ‚Äî —ç—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–µ endpoints.

### 3. Admin endpoints
`/api/admin/*` ‚Äî —É–∂–µ –∑–∞—â–∏—â–µ–Ω—ã `get_current_admin_user`, feature gates –ù–ï –Ω—É–∂–Ω—ã.

### 4. Backward compatibility
**–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ feature gates —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ë–ï–ó –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ—Ç–µ—Ä—è—é—Ç –¥–æ—Å—Ç—É–ø!**

–†–µ—à–µ–Ω–∏–µ:
- –ü—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∏—Ç—å Basic –ø–ª–∞–Ω –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å `plan_id = NULL` –∏ —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å `kaspi_stores`
- –ò–ª–∏ –¥–∞—Ç—å grace period (14 –¥–Ω–µ–π) –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Ç–∞—Ä–∏—Ñ–∞

---

## –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

### –ú–∞—Ç—Ä–∏—Ü–∞ "–ö—Ç–æ —á—Ç–æ –º–æ–∂–µ—Ç"

| –§–∏—á–∞ | Free | Basic | Standard | Premium | –ê–¥–¥–æ–Ω |
|------|------|-------|----------|---------|-------|
| ai_lawyer | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | - |
| analytics | ‚ùå | ‚úÖ (100) | ‚úÖ (500) | ‚úÖ (unlim) | ‚úÖ (unlim addon) |
| demping | ‚ùå | ‚úÖ (50) | ‚úÖ (100) | ‚úÖ (200) | ‚úÖ (+100 addon) |
| unit_economics | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | - |
| invoice_glue | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | - |
| orders_view | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | - |
| preorder | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ (addon) |
| niche_search | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | - |
| whatsapp_auto | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ (addon) |
| whatsapp_bulk | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ (addon) |
| city_demping | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ (addon) |
| ai_salesman | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ (ONLY addon!) |

