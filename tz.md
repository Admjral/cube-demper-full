Общий принцип для всех ИИ

должна быть единая схема

Webhook событие
→ сбор данных
→ валидация магазина
→ сбор контекста
→ ИИ агент
→ результат
→ логирование

ИИ продажник
ИИ юрист
ИИ бухгалтер
отличаются только источниками данных и промптом

1 Роль ИИ продажника

ИИ продажник это
Не саппорт
Не просто чат
А автоматический менеджер допродаж и удержания

Он работает на событиях а не по запросу

2 Сценарии работы
2 1 После покупки

Триггер оформление заказа
ИИ анализирует
Купленный товар
Историю покупок клиента
Каталог магазина
Наличие товаров

Результат
Персональное предложение допродажи или апсейла в WhatsApp

2 2 Повторные продажи

Если клиент покупал ранее
ИИ предлагает
Расходники
Аналоги дороже
Комплекты

2 3 Отзывы

Если первая покупка
Просьба оставить отзыв
Если не первая
Отзыв плюс бонус скидка

2 4 Реакция на ответы

Если клиент отвечает
ИИ продолжает диалог
Отвечает на возражения
Предлагает альтернативы

3 Настройки магазина

Каждый магазин настраивает
Тон общения
Шаблоны сообщений
Процент скидки за отзыв
Промокоды
Ограничения по категориям

4 Ограничения

ИИ
Не обещает то чего нет
Не нарушает правила Kaspi

Шаг 1 Webhook событие

Purchase Trigger Webhook
Приходит событие о покупке
shop_id
товар
цена
номер заказа
whatsapp клиента

Шаг 2 Нормализация данных

Extract Purchase Data
Все входящие поля приводятся к единому формату
Это защита от кривых интеграций

Шаг 3 Проверка магазина

Get Shop Settings
Берем настройки магазина из Supabase

Validate Shop
Проверяем
магазин существует
магазин активен

Если нет отправляется ошибка

Шаг 4 Сохранение покупки

Save Purchase
Записываем покупку в БД
Это основа аналитики и истории

Шаг 5 Сбор контекста для ИИ

Параллельно подтягивается
Все товары магазина
История покупок клиента
Шаблон промпта
Настройки ИИ магазина

Шаг 6 Подготовка промпта

Prepare AI Data
Формируется единый контекст
магазин
купленный товар
каталог
история клиента
настройки

Это ключевая часть качества ИИ

Шаг 7 ИИ продажник

Upsell AI Agent
ИИ получает
что купили
кто купил
что еще есть
как принято продавать в этом магазине

ИИ генерирует персональное предложение

Шаг 8 Форматирование

Format Message
Экранирование
HTML
жирный текст
чтобы WhatsApp не ломался

Шаг 9 Отправка в WhatsApp

Send WhatsApp Message
Сообщение уходит клиенту

Шаг 10 Логика отзывов

Check First Purchase
Если первая покупка
один сценарий
Если повторная
другой сценарий

Что я предлагаю улучшить дальше

1 Добавить скоринг клиента
частота покупок
средний чек

2 Добавить тайминги
допродажа не сразу а через 10 30 минут

3 Добавить запреты
не писать ночью
не писать чаще N раз

4 Связать с ИИ бухгалтером
предлагать только маржинальные товары

ИИ ЮРИСТ JSON ТЗ
1 Триггеры
Webhook события
* блокировка товара
* штраф
* возврат
* спор с клиентом
* ручной запрос пользователя
Пример
POST /legal-event

2 Входные данные JSON

{
  "shop_id": "kaspi_123",
  "event_type": "fine",
  "order_id": "KSP-556677",
  "product_name": "Мужской шампунь",
  "fine_reason": "Нарушение сроков доставки",
  "documents": [
    "fine_notice.pdf",
    "kaspi_message.txt"
  ]
}

3 Сбор контекста
БД
* настройки магазина
* история штрафов
* тип бизнеса ИП ТОО
* предыдущие ответы Kaspi
База знаний
* оферта Kaspi
* законы РК
* шаблоны возражений

4 Prepare AI Data

{
  "shop": {},
  "event": {
    "type": "fine",
    "reason": "Нарушение сроков доставки"
  },
  "order": {},
  "documents_text": "...",
  "legal_base": "...",
  "prompt_template": "Проанализируй ситуацию и подготовь ответ Kaspi"
}

5 ИИ Юрист Agent
System prompt
Ты юрист маркетплейсов РК
Работаешь строго в рамках закона
Дай рекомендации и подготовь документ
Результат
* разбор ситуации
* можно ли оспорить
* риски
* готовый текст документа

6 Выход

{
  "analysis": "Штраф можно оспорить так как...",
  "risk_level": "medium",
  "document": "Текст возражения...",
  "recommendation": "Отправить в Kaspi в течение 3 дней"
}

ИИ БУХГАЛТЕР JSON ТЗ
1 Триггеры
Webhook события
* новая продажа
* закрытие месяца
* ручной запрос
POST /finance-event

2 Входные данные JSON

{
  "shop_id": "kaspi_123",
  "period": "2026-01",
  "event_type": "monthly_report"
}

3 Сбор данных
БД
* продажи
* комиссии
* доставка
* себестоимость
Интеграции
* Kaspi 
* Excel
* банк

4 Prepare AI Data

{
  "shop": {},
  "sales": [],
  "expenses": [],
  "tax_mode": "IP_USN",
  "previous_period": {}
}

5 ИИ Бухгалтер Agent
System prompt
Ты бухгалтер в РК
Считаешь строго по налоговому кодексу
Не выдумываешь
Задачи
* посчитать прибыль
* налоги
* найти убыточные товары
* дать рекомендации

6 Выход

{
  "revenue": 1250000,
  "profit": 420000,
  "tax_due": 63000,
  "loss_products": [
    {
      "product": "Чехол iPhone",
      "reason": "Комиссия выше маржи"
    }
  ],
  "recommendations": [
    "Поднять цену на 7%",
    "Убрать товар из ассортимента"
  ]
}

Нужно собрать в одну систему
И у нас получится ИИ штаб
* ИИ продажник зарабатывает
* ИИ бухгалтер считает
* ИИ юрист защищает
Все работают
* на одних и тех же данных
* в одном БД
* через одинаковые JSON пайплайны

