# Kaspi API Rate Limits — Результаты тестов (2026-02-08)

## Тестовые условия
- IP: домашний (без прокси)
- Браузер: Chrome, консоль на kaspi.kz / kaspi.kz/mc/
- Merchant UID: 30326683
- Тестовые товары: 115625025, 135697511, 130030210, 106411528

---

## 1. Публичный endpoint — конкуренты (RPS)

**Endpoint:** `POST https://kaspi.kz/yml/offer-view/offers/{product_id}`
**Авторизация:** не требуется
**Используется:** проверка цен конкурентов

| Метрика | Значение |
|---------|----------|
| Безопасный RPS | ~10 |
| Лимит RPS | ~15 |
| Тип бана | 403 Forbidden |
| Привязка | По IP |
| Длительность бана | ~10 сек |
| Всего успешных | 1011 |
| Заблокировано | 4 |
| Лимит по количеству | Нет (1400+ запросов без бана при 1 RPS) |

**Вывод:** Kaspi не шлёт 429, сразу 403. Безопасный потолок — 10 RPS. Лимита по общему количеству нет — только по RPS. Бан моментально снимается при снижении нагрузки (~10 сек).

---

## 2. Мерчант API — каталог товаров

**Endpoint:** `GET https://mc.shop.kaspi.kz/bff/offer-view/list?m={merchant_uid}`
**Авторизация:** cookies (сессия мерчанта)
**Используется:** загрузка списка товаров продавца

| Метрика | Значение |
|---------|----------|
| Отправлено запросов | 637 |
| Заблокировано | 0 |
| Ошибок | 0 |
| Время теста | ~11 мин |
| RPS теста | 1 |
| Лимит по количеству | Нет |
| Лимит по RPS | Не найден (при 1 RPS) |

**Вывод:** Самый лояльный endpoint. Лимита по количеству нет. RPS лимит не тестировался выше 1, но предполагаем ~10-15 как у публичного.

---

## 3. Синк цен (pricefeed)

**Endpoint:** `POST https://mc.shop.kaspi.kz/pricefeed/upload/merchant/process`
**Авторизация:** cookies (сессия мерчанта)
**Используется:** изменение цены товара

| Метрика | Значение |
|---------|----------|
| Безопасный RPS | ~2 |
| Лимит RPS | ~3 |
| Тип бана | 429 Too Many Requests |
| Привязка | По аккаунту (сессии) |
| Длительность бана | **~30 мин** |
| Всего успешных | 62 |
| Заблокировано | 19 |

**Вывод:** Самый строгий и опасный лимит. При превышении 3 RPS — бан на 30 минут. Прокси НЕ помогут — лимит привязан к аккаунту мерчанта, не к IP. Критически важно держать ≤2 RPS на синке.

---

## Сводная таблица

| Endpoint | Назначение | Лимит RPS | Тип бана | Длительность бана | Привязка |
|----------|-----------|-----------|----------|-------------------|----------|
| `/yml/offer-view/offers/{id}` | Цены конкурентов | ~10 safe / ~15 ban | 403 | ~10 сек | IP |
| `/bff/offer-view/list` | Каталог мерчанта | >1 (не найден) | — | — | — |
| `/pricefeed/upload/merchant/process` | Синк цены | ~2 safe / ~3 ban | 429 | **~30 мин** | Аккаунт |

---

## Ключевые выводы

1. **Два разных типа защиты:**
   - Публичный endpoint — лёгкий IP-бан, снимается за 10 сек. Решается прокси.
   - Синк цен — жёсткий аккаунт-бан на 30 мин. Прокси НЕ помогут.

2. **Лимитов по количеству нет** — ограничение только по RPS (скорости).

3. **Bottleneck при масштабировании:**
   - Проверка конкурентов — упирается в IP (решается прокси)
   - Синк цен — упирается в аккаунт (у каждого юзера свои 2 RPS — не проблема)

---

## Расчёт масштабирования

### 1 пользователь (200 товаров, цикл 30 мин)
- Проверка конкурентов: 200 req / 10 RPS = **20 сек**
- Синк цен (20% = 40 товаров): 40 req / 2 RPS = **20 сек**
- **Итого цикл: ~40 сек** (укладывается в 30 мин с огромным запасом)

### 400 пользователей (80,000 товаров, цикл 30 мин)

**Проверка конкурентов (публичный endpoint):**
- 80,000 req за 1,800 сек = 44.4 RPS нужно
- 1 IP (10 RPS) = 2.2 часа ❌
- 5 прокси (50 RPS) = 27 мин ✅
- 6 прокси (60 RPS) = 22 мин ✅ (с запасом)

**Синк цен (pricefeed):**
- Лимит по аккаунту → каждый юзер свои 2 RPS
- 200 товаров × 20% = 40 синков / 2 RPS = 20 сек на юзера ✅
- Все 400 юзеров параллельно — ок, лимиты не пересекаются

### Необходимое количество прокси (только для проверки конкурентов)

| Юзеров | Товаров | Прокси (цикл 30 мин) | Стоимость (~$4/IP/мес) |
|--------|---------|----------------------|------------------------|
| 100 | 20,000 | 2 | $8 |
| 200 | 40,000 | 3 | $12 |
| 400 | 80,000 | 6 | $24 |
| 700 | 140,000 | 10 | $40 |
| 1,000 | 200,000 | 15 | $60 |

*Расчёт: безопасный 8 RPS на прокси, цикл 30 мин = 14,400 req на прокси*

---

## Рекомендации для воркера

1. **Rate limiter для синка:** строго ≤2 RPS per session, с задержкой 500мс между запросами
2. **Rate limiter для проверки конкурентов:** ≤8 RPS per IP (с запасом от 10)
3. **При 429 на синке:** полная пауза 30 мин для этого аккаунта, не пытаться раньше
4. **При 403 на проверке:** пауза 10 сек, затем продолжить
5. **Прокси:** статические резидентные KZ, только для публичного endpoint
6. **Текущий RPS_LIMIT=60 в коде:** снизить до 8-10 для одного IP

---

## Не протестировано

- [ ] Мерчант API каталог — RPS лимит (при >1 RPS)
- [ ] Синк цен — подтверждение что лимит по аккаунту (нужен второй аккаунт)
