# Cube Demper ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ö–æ–Ω—Ç—Ä–æ–ª—å –î–æ—Å—Ç—É–ø–∞

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–æ–±—â–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
2. [–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏](#–º–æ–¥–µ–ª—å-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
3. [–¢–∞—Ä–∏—Ñ–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞](#—Ç–∞—Ä–∏—Ñ–Ω–∞—è-—Å–∏—Å—Ç–µ–º–∞)
4. [–ú–æ–¥—É–ª–∏ –∏ –∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏](#–º–æ–¥—É–ª–∏-–∏-–∏—Ö-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
5. [Ownership –º–æ–¥–µ–ª—å](#ownership-–º–æ–¥–µ–ª—å)
6. [–ì—Ä–∞–Ω–∏—Ü—ã –¥–æ—Å—Ç—É–ø–∞](#–≥—Ä–∞–Ω–∏—Ü—ã-–¥–æ—Å—Ç—É–ø–∞)
7. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—é](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-—Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—é)

---

## üèóÔ∏è –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°–ª–æ–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Frontend (Next.js)                    ‚îÇ
‚îÇ  - Dashboard UI                                          ‚îÇ
‚îÇ  - API Client (fetch + Bearer token)                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ HTTP/REST + WebSocket
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Backend (FastAPI)                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  Routers (Endpoints)                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Auth, Billing, Kaspi, WhatsApp, AI, etc.     ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  Dependencies (Auth & Feature Gates)             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - get_current_user()                            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - require_feature("feature_name")               ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  Services (Business Logic)                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - kaspi_orders_api, kaspi_products_api          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - ai_salesman, ai_lawyer                        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - feature_access, notification_service          ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               Workers (Background)                       ‚îÇ
‚îÇ  - demper_instance.py (price demping)                   ‚îÇ
‚îÇ  - orders_sync_service.py (8 min cycle)                 ‚îÇ
‚îÇ  - preorder_checker.py (5 min cycle)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Databases & External APIs                   ‚îÇ
‚îÇ  - PostgreSQL (users, stores, products, subscriptions)  ‚îÇ
‚îÇ  - Redis (cache, sessions)                              ‚îÇ
‚îÇ  - Kaspi API (REST + MC GraphQL)                        ‚îÇ
‚îÇ  - Google Gemini (AI features)                          ‚îÇ
‚îÇ  - WAHA (WhatsApp)                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîê –ú–æ–¥–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### 1. –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```python
# dependencies.py

ROLES = {
    "user": "–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (owner –º–∞–≥–∞–∑–∏–Ω–æ–≤)",
    "admin": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (full access)",
    "partner": "–ü–∞—Ä—Ç–Ω—ë—Ä (—Ä–µ—Ñ–µ—Ä–∞–ª–∫–∞, –æ—Ç–¥–µ–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)"
}
```

### 2. JWT —Ç–æ–∫–µ–Ω—ã

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ JWT payload:**
```json
{
  "sub": "user_id (UUID)",
  "role": "user|admin|partner",
  "exp": "expiration timestamp"
}
```

**–¢–∏–ø—ã —Ç–æ–∫–µ–Ω–æ–≤:**
- `role: "user"` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `role: "admin"` ‚Äî –∞–¥–º–∏–Ω —Ç–æ–∫–µ–Ω
- `role: "partner"` ‚Äî –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π —Ç–æ–∫–µ–Ω
- `role: "password_reset"` ‚Äî –ù–ï –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –≤ `get_current_user()` (–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è)

### 3. Dependency Injection (DI)

#### `get_current_user()`
```python
# –ë–∞–∑–æ–≤–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ 95% endpoints
async def get_current_user(
    authorization: Header,
    pool: asyncpg.Pool
) -> dict:
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Bearer token
    # 2. –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ JWT
    # 3. –í–∞–ª–∏–¥–∞—Ü–∏—è role in ("user", "admin")
    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ is_blocked
    # 5. –í–æ–∑–≤—Ä–∞—Ç user dict —Å –ø–æ–ª—è–º–∏:
    return {
        "id": UUID,
        "email": str,
        "role": "user" | "admin",
        "phone": str | None,
        "phone_verified": bool,
        "company_name": str | None,
        # ...
    }
```

#### `get_current_admin_user()`
```python
# –ê–¥–º–∏–Ω-—Ç–æ–ª—å–∫–æ endpoints
async def get_current_admin_user(
    current_user: Depends(get_current_user)
) -> dict:
    if current_user["role"] != "admin":
        raise AuthorizationError("Admin access required")
    return current_user
```

#### `require_feature("feature_name")`
```python
# Feature-gated endpoints (—Ç–∞—Ä–∏—Ñ–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)
def require_feature(feature: str):
    async def dependency(
        current_user: Depends(get_current_user),
        pool: asyncpg.Pool
    ) -> dict:
        has_access, message = await feature_access.check_feature_access(
            pool, current_user['id'], feature
        )
        if not has_access:
            raise HTTPException(403, detail={
                "error": "feature_not_available",
                "feature": feature,
                "message": message
            })
        return current_user
    return Depends(dependency)
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
@router.post("/ai/salesman/settings")
async def update_ai_settings(
    current_user: Annotated[dict, require_feature("ai_salesman")],
    # ...
):
    # –¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å feature "ai_salesman" –º–æ–≥—É—Ç –ø–æ–ø–∞—Å—Ç—å —Å—é–¥–∞
```

---

## üí∞ –¢–∞—Ä–∏—Ñ–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

### 1. –ü–ª–∞–Ω—ã (Plans)

**–¢–∞–±–ª–∏—Ü–∞:** `plans`

| –ü–ª–∞–Ω | –ö–æ–¥ | –¶–µ–Ω–∞ (—Ç–µ–Ω–≥–µ) | Analytics Limit | Demping Limit | –§–∏—á–∏ |
|------|-----|--------------|-----------------|---------------|------|
| Free | `free` | 0 | 0 | 0 | (–Ω–µ—Ç —Ñ–∏—á) |
| Basic | `basic` | 21,990 | 500 | 50 | analytics, demping, exclude_own_stores, invoice_glue, orders_view, unit_economics, ai_lawyer, priority_support |
| Standard | `standard` | 27,990 | 1,000 | 100 | Basic + preorder, whatsapp_auto, niche_search, city_demping |
| Premium | `premium` | 33,990 | -1 (unlim) | 200 | Standard + whatsapp_bulk, delivery_demping, priority_products |

**Trial:**
- `trial_days` = 7 –¥–Ω–µ–π (–ø–ª–∞–Ω Basic)
- Anti-abuse: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ `kaspi_stores.merchant_id` + `users.phone` ‚Äî –æ–¥–∏–Ω –º–∞–≥–∞–∑–∏–Ω/—Ç–µ–ª–µ—Ñ–æ–Ω = –æ–¥–∏–Ω trial **–Ω–∞ –≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã**

### 2. –ê–¥–¥–æ–Ω—ã (Add-ons)

**–¢–∞–±–ª–∏—Ü–∞:** `addons`

| –ê–¥–¥–æ–Ω | –ö–æ–¥ | –¶–µ–Ω–∞ (—Ç–µ–Ω–≥–µ) | Recurring | Stackable | –§–∏—á–∏ |
|-------|-----|------|-----------|-----------|------|
| –ò–ò –ü—Ä–æ–¥–∞–∂–Ω–∏–∫ | `ai_salesman` | 15,000 | ‚úÖ | ‚ùå | ai_salesman |
| –ü—Ä–µ–¥–∑–∞–∫–∞–∑ | `preorder` | 10,000 | ‚úÖ | ‚ùå | preorder |
| WhatsApp —Ä–∞—Å—Å—ã–ª–∫–∞ | `whatsapp` | 15,000 | ‚úÖ | ‚ùå | whatsapp_auto, whatsapp_bulk |
| –î–µ–º–ø–∏–Ω–≥ +100 | `demping_100` | 10,000 | ‚úÖ | ‚úÖ | +100 –∫ demping_limit |
| –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–µ–∑–ª–∏–º–∏—Ç | `analytics_unlimited` | 20,000 | ‚úÖ | ‚ùå | analytics_limit = -1 |
| –î–µ–º–ø–µ—Ä –ø–æ –≥–æ—Ä–æ–¥–∞–º | `city_demping` | 10,000 | ‚úÖ | ‚ùå | city_demping |
| –î–µ–º–ø–µ—Ä –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ | `delivery_demping` | 10,000 | ‚úÖ | ‚ùå | delivery_demping |

### 3. Feature Access Service

**–°–µ—Ä–≤–∏—Å:** `services/feature_access.py`

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

```python
# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ñ–∏—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
features = await feature_access.get_user_features(pool, user_id)
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
{
    "plan_code": str | None,          # "basic", "standard", etc.
    "plan_name": str | None,          # "–ë–∞–∑–æ–≤—ã–π", "–°—Ç–∞–Ω–¥–∞—Ä—Ç", etc.
    "features": list[str],            # ["analytics", "demping", "ai_lawyer", ...]
    "analytics_limit": int,           # -1 = unlimited
    "demping_limit": int,
    "has_active_subscription": bool,  # True –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
    "is_trial": bool,
    "trial_ends_at": datetime | None,
    "subscription_ends_at": datetime | None,
}

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ñ–∏—á–µ
has_access, message = await feature_access.check_feature_access(
    pool, user_id, "ai_salesman"
)

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç
within_limit, max_limit, message = await feature_access.check_limit(
    pool, user_id, "demping", current_count=150
)
```

**–§–∏—á–∏:**

| –§–∏—á–∞ | –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è |
|------|------------|
| `analytics` | Plans: basic, standard, premium |
| `demping` | Plans: basic, standard, premium |
| `ai_lawyer` | Plans: basic, standard, premium |
| `orders_view` | Plans: basic, standard, premium |
| `invoice_glue` | Plans: basic, standard, premium |
| `unit_economics` | Plans: basic, standard, premium |
| `exclude_own_stores` | Plans: basic, standard, premium |
| `priority_support` | Plans: basic, standard, premium |
| `preorder` | Plans: standard, premium OR Addon: preorder |
| `whatsapp_auto` | Plans: standard, premium OR Addon: whatsapp |
| `whatsapp_bulk` | Plans: premium OR Addon: whatsapp |
| `niche_search` | Plans: standard, premium |
| `city_demping` | Plans: standard, premium OR Addon: city_demping |
| `delivery_demping` | Plans: premium OR Addon: delivery_demping |
| `priority_products` | Plans: premium |
| `ai_salesman` | Addon: ai_salesman ONLY |

---

## üß© –ú–æ–¥—É–ª–∏ –∏ –∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### 1. Core –º–æ–¥—É–ª–∏ (–±–µ–∑ —Ç–∞—Ä–∏—Ñ–æ–≤)

**–î–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:**

- **Auth** (`/auth`)
  - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ª–æ–≥–∏–Ω, OTP
  - –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è (TODO: email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è)
  - –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏

- **Billing** (`/billing`)
  - –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–ª–∞–Ω–æ–≤ –∏ –∞–¥–¥–æ–Ω–æ–≤
  - –ê–∫—Ç–∏–≤–∞—Ü–∏—è trial (1 —Ä–∞–∑ per merchant_id)
  - –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–ª–∞—Ç–µ–∂–µ–π
  - –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

- **Support** (`/support`)
  - WebSocket + HTTP chat
  - –î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
  - Notifications –ø—Ä–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –æ—Ç –∞–¥–º–∏–Ω–∞

- **Notifications** (`/notifications`)
  - –ü—Ä–æ—Å–º–æ—Ç—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (`notification_settings` JSONB)
  - –î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–º

- **Health** (`/health`)
  - Healthcheck endpoints
  - –ü—É–±–ª–∏—á–Ω—ã–µ (no auth)

### 2. Kaspi Integration (–±–∞–∑–æ–≤—ã–µ —Ñ–∏—á–∏ —Ç—Ä–µ–±—É—é—Ç Plan)

**–ú–æ–¥—É–ª—å:** `/kaspi`

**Ownership:** `kaspi_stores.user_id = current_user['id']`

**Endpoints –±–µ–∑ feature gates:**
- `GET /stores` ‚Äî —Å–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `POST /stores/connect` ‚Äî –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ (Playwright auth)
- `PATCH /stores/{store_id}/api-token` ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ API —Ç–æ–∫–µ–Ω–∞
- `POST /stores/{store_id}/test-api-token` ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
- `GET /stores/{store_id}/products` ‚Äî —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –º–∞–≥–∞–∑–∏–Ω–∞

**Endpoints —Å feature gates:**
- `POST /stores/{store_id}/sync` ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ (—Ç—Ä–µ–±—É–µ—Ç `analytics` OR `demping`)
- `POST /stores/{store_id}/run-demping` ‚Äî –¥–µ–º–ø–∏–Ω–≥ —Ü–µ–Ω (—Ç—Ä–µ–±—É–µ—Ç `demping`)
- `GET /stores/{store_id}/analytics` ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (—Ç—Ä–µ–±—É–µ—Ç `analytics`)
- `GET /orders/{store_id}/{order_code}/customer` ‚Äî —Ç–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞ (—Ç—Ä–µ–±—É–µ—Ç `orders_view`)

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
```
kaspi.router
  ‚îú‚îÄ kaspi_auth_service (Playwright –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
  ‚îú‚îÄ kaspi_orders_api (REST API, Base64 —Ç–µ–ª–µ—Ñ–æ–Ω—ã)
  ‚îú‚îÄ kaspi_products_api (REST API, –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–æ–≤)
  ‚îú‚îÄ kaspi_mc_service (MC GraphQL, fallback)
  ‚îî‚îÄ api_parser (offers, sync_orders_to_db, parse_product_by_sku)
```

### 3. Demping Worker (—Ñ–æ–Ω–æ–≤—ã–π)

**–ú–æ–¥—É–ª—å:** `workers/demper_instance.py`

**–ó–∞–ø—É—Å–∫:** –æ—Ç–¥–µ–ª—å–Ω—ã–π process (worker-1, worker-2)

**Ownership:** —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã –≥–¥–µ `products.store_id IN (user's stores)` AND `bot_active = TRUE`

**–§–∏–ª—å—Ç—Ä—ã:**
- `kaspi_stores.is_active = TRUE`
- `kaspi_stores.needs_reauth = FALSE`
- `products.bot_active = TRUE`
- `work_hours` (KZ timezone)
- Sharding –ø–æ `mod(abs(hashtext(id::text)), WORKER_COUNT) = INDEX`

**–ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞** ‚Äî –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã

### 4. WhatsApp (`/whatsapp`)

**–§–∏—á–∏:**
- `whatsapp_auto` ‚Äî –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã, —à–∞–±–ª–æ–Ω—ã
- `whatsapp_bulk` ‚Äî –º–∞—Å—Å–æ–≤—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏ (broadcast)

**Ownership:** `whatsapp_sessions.store_id ‚Üí kaspi_stores.user_id`

**Endpoints:**
```python
POST /sessions                         # –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é (—Ç—Ä–µ–±—É–µ—Ç store ownership)
GET /sessions                          # –°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
POST /sessions/{session_id}/broadcast  # –†–∞—Å—Å—ã–ª–∫–∞ (—Ç—Ä–µ–±—É–µ—Ç whatsapp_bulk)
GET /contacts                          # –ö–æ–Ω—Ç–∞–∫—Ç—ã (customer_contacts.store_id)
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- `waha_service.py` (WAHA API client)
- `ai_salesman_service.py` (auto-reply —á–µ—Ä–µ–∑ webhook)

### 5. AI Salesman (`/ai/salesman`)

**–§–∏—á–∞:** `ai_salesman` (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∞–¥–¥–æ–Ω!)

**Ownership:** `ai_salesman_settings.store_id ‚Üí kaspi_stores.user_id`

**Endpoints:**
```python
POST /ai/salesman/settings           # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (require_feature("ai_salesman"))
GET /ai/salesman/stats/{store_id}    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (require_feature("ai_salesman"))
GET /ai/salesman/history/{store_id}  # –ò—Å—Ç–æ—Ä–∏—è (require_feature("ai_salesman"))
POST /ai/salesman/process-order      # –†—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–∞ (require_feature("ai_salesman"))
```

**Auto-reply:**
- Webhook `POST /whatsapp/webhook` ‚Üí `handle_incoming_message()`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ñ–∏—á–∏ `ai_salesman` —É –≤–ª–∞–¥–µ–ª—å—Ü–∞ store
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ Gemini
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ WAHA

### 6. AI Lawyer (`/ai/lawyer` + `/ai/chat`)

**–§–∏—á–∞:** `ai_lawyer` (–¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –≤—Å–µ—Ö –ø–ª–∞—Ç–Ω—ã—Ö –ø–ª–∞–Ω–∞—Ö)

**Endpoints:** –í—Å–µ –∑–∞–∫—Ä—ã—Ç—ã `require_feature("ai_lawyer")`:
- `lawyer.py`: 16 endpoints (chat, calculators, documents, PDF)
- `ai.py`: `/ai/chat` (–æ–±—â–∏–π —á–∞—Ç-endpoint)

### 7. Preorders (`/preorders`)

**–§–∏—á–∞:** `preorder`

**Ownership:** `preorders.store_id ‚Üí kaspi_stores.user_id`

**Endpoints:** –í—Å–µ –∑–∞–∫—Ä—ã—Ç—ã `require_feature("preorder")`:
- `GET/POST/PUT/DELETE /preorders`

**Background checker:** `preorder_checker.py` (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω) ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤

### 8. Unit Economics (`/unit-economics`)

**–§–∏—á–∞:** `unit_economics`

**Endpoints:** –í—Å–µ –∑–∞–∫—Ä—ã—Ç—ã `require_feature("unit_economics")`

### 9. Invoices (`/invoices`)

**–§–∏—á–∞:** `invoice_glue`

**Endpoints:** `POST /merge` –∑–∞–∫—Ä—ã—Ç `require_feature("invoice_glue")`

### 10. Niche Search (`/niches`)

**–§–∏—á–∞:** `niche_search` (Standard+)

**Endpoints:** –í—Å–µ –∑–∞–∫—Ä—ã—Ç—ã `require_feature("niche_search")`

---

## üîë Ownership –º–æ–¥–µ–ª—å

### –ò–µ—Ä–∞—Ä—Ö–∏—è –≤–ª–∞–¥–µ–Ω–∏—è

```
User (users.id)
  ‚îî‚îÄ Kaspi Store (kaspi_stores.user_id)
      ‚îú‚îÄ Products (products.store_id)
      ‚îú‚îÄ Orders (orders.store_id)
      ‚îú‚îÄ WhatsApp Sessions (whatsapp_sessions.store_id)
      ‚îú‚îÄ AI Salesman Settings (ai_salesman_settings.store_id)
      ‚îú‚îÄ Preorders (preorders.store_id)
      ‚îî‚îÄ Customer Contacts (customer_contacts.store_id)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ ownership –≤ –∫–æ–¥–µ

**–ü–∞—Ç—Ç–µ—Ä–Ω:**
```python
@router.get("/stores/{store_id}/products")
async def get_products(
    store_id: str,
    current_user: Annotated[dict, Depends(get_current_user)],
    pool: Annotated[asyncpg.Pool, Depends(get_db_pool)]
):
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ store –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    async with pool.acquire() as conn:
        store = await conn.fetchrow(
            "SELECT id FROM kaspi_stores WHERE id = $1 AND user_id = $2",
            uuid.UUID(store_id), current_user['id']
        )
        if not store:
            raise HTTPException(404, detail="Store not found")

    # 2. –î–∞–ª—å–Ω–µ–π—à–∞—è –ª–æ–≥–∏–∫–∞
    # ...
```

**‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ:** –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `user_id` –≤ JOIN –∑–∞–ø—Ä–æ—Å–∞—Ö!

**–ü–ª–æ—Ö–æ:**
```sql
-- –û–ø–∞—Å–Ω–æ! –õ—é–±–æ–π –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á—É–∂–æ–≥–æ store
SELECT * FROM products WHERE store_id = $1
```

**–•–æ—Ä–æ—à–æ:**
```sql
-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ: –ø—Ä–æ–≤–µ—Ä—è–µ–º ownership —á–µ—Ä–µ–∑ JOIN
SELECT p.* FROM products p
JOIN kaspi_stores s ON s.id = p.store_id
WHERE p.store_id = $1 AND s.user_id = $2
```

---

## üöß –ì—Ä–∞–Ω–∏—Ü—ã –¥–æ—Å—Ç—É–ø–∞

### 1. –ü–æ —Ä–æ–ª—è–º

| –†–æ–ª—å | –î–æ—Å—Ç—É–ø |
|------|--------|
| `user` | –¢–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ (ownership check) |
| `admin` | Full access –∫–æ –≤—Å–µ–º endpoints |
| `partner` | –¢–æ–ª—å–∫–æ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–µ endpoints (`/partner`) |

### 2. –ü–æ —Ç–∞—Ä–∏—Ñ–∞–º

#### Free –ø–ª–∞–Ω (plan_id = NULL)
- ‚úÖ Auth, Support, Notifications
- ‚ùå –î–µ–º–ø–∏–Ω–≥, –ê–Ω–∞–ª–∏—Ç–∏–∫–∞, AI, WhatsApp, Preorders
- ‚úÖ Trial activation (1 —Ä–∞–∑)

#### Basic –ø–ª–∞–Ω (21,990‚Ç∏)
- ‚úÖ Analytics (500 —Ç–æ–≤–∞—Ä–æ–≤)
- ‚úÖ Demping (50 —Ç–æ–≤–∞—Ä–æ–≤)
- ‚úÖ AI Lawyer, Orders View, Invoice Glue, Unit Economics
- ‚úÖ Exclude Own Stores, Priority Support
- ‚ùå Preorder, WhatsApp, Niche Search, AI Salesman

#### Standard –ø–ª–∞–Ω (27,990‚Ç∏)
- ‚úÖ Basic +
- ‚úÖ Analytics (1,000 —Ç–æ–≤–∞—Ä–æ–≤), Demping (100 —Ç–æ–≤–∞—Ä–æ–≤)
- ‚úÖ Preorder, WhatsApp Auto, Niche Search, City Demping

#### Premium –ø–ª–∞–Ω (33,990‚Ç∏)
- ‚úÖ Standard +
- ‚úÖ Analytics (unlimited), Demping (200 —Ç–æ–≤–∞—Ä–æ–≤)
- ‚úÖ WhatsApp Bulk, Delivery Demping, Priority Products

#### –ê–¥–¥–æ–Ω—ã (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø–ª–∞–Ω–∞)
- AI Salesman (15,000‚Ç∏) ‚Äî –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ –∞–¥–¥–æ–Ω
- Preorder (10,000‚Ç∏) ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏—á—É –∫ Free/Basic
- WhatsApp (15,000‚Ç∏) ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç whatsapp_auto + whatsapp_bulk
- Demping +100 (10,000‚Ç∏) ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ª–∏–º–∏—Ç (stackable)
- Analytics Unlimited (20,000‚Ç∏) ‚Äî —Å–Ω–∏–º–∞–µ—Ç –ª–∏–º–∏—Ç
- City Demping (10,000‚Ç∏) ‚Äî –¥–µ–º–ø–µ—Ä –ø–æ –≥–æ—Ä–æ–¥–∞–º
- Delivery Demping (10,000‚Ç∏) ‚Äî –¥–µ–º–ø–µ—Ä –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ

### 3. –ü–æ –¥–∞–Ω–Ω—ã–º

#### User-scoped
- **Subscriptions** ‚Äî —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏
- **Payments** ‚Äî —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏
- **Notifications** ‚Äî —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏
- **Support chats** ‚Äî —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏

#### Store-scoped
- **Kaspi Stores** ‚Äî —Ç–æ–ª—å–∫–æ –≥–¥–µ `user_id = current_user['id']`
- **Products** ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ ownership store
- **Orders** ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ ownership store
- **WhatsApp Sessions** ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ ownership store
- **AI Salesman Settings** ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ ownership store
- **Preorders** ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ ownership store

#### Global (no ownership)
- **Plans** ‚Äî –ø—É–±–ª–∏—á–Ω—ã–µ
- **Addons** ‚Äî –ø—É–±–ª–∏—á–Ω—ã–µ
- **Niches** ‚Äî –ø—É–±–ª–∏—á–Ω—ã–µ (—Å—Ç–∞—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

---

## üõ°Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—é

### 1. –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (—Ç—Ä–µ–±—É—é—Ç —Ñ–∏–∫—Å–∞)

#### ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ feature gates

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (2026-02-15). –í—Å–µ —Ä–æ—É—Ç–µ—Ä—ã —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç `require_feature()`:
- `routers/lawyer.py` ‚Äî `require_feature("ai_lawyer")`
- `routers/preorders.py` ‚Äî `require_feature("preorder")`
- `routers/unit_economics.py` ‚Äî `require_feature("unit_economics")`
- `routers/invoices.py` ‚Äî `require_feature("invoice_glue")`
- `routers/niches.py` ‚Äî `require_feature("niche_search")`
- `routers/ai.py` ‚Äî `/ai/chat` ‚Üí `require_feature("ai_lawyer")`, salesman endpoints ‚Üí `require_feature("ai_salesman")`
- `routers/whatsapp.py` ‚Äî `/send/bulk` ‚Üí `require_feature("whatsapp_bulk")`

#### ‚ùå Kaspi Stores ‚Äî multiple ownership

**–ü—Ä–æ–±–ª–µ–º–∞:** ON CONFLICT –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç `user_id` ‚Äî –æ–¥–∏–Ω –º–∞–≥–∞–∑–∏–Ω –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

**–§–∞–π–ª:** `routers/kaspi.py:connect_store()`

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ü–µ—Ä–µ–¥ INSERT –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π store
existing = await conn.fetchrow(
    "SELECT user_id FROM kaspi_stores WHERE merchant_id = $1",
    merchant_id
)
if existing and existing['user_id'] != current_user['id']:
    raise HTTPException(400, detail="Store already connected to another account")
```

### 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

#### üí° –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ ownership checks

**–°–æ–∑–¥–∞—Ç—å dependency:**
```python
# dependencies.py
async def require_store_ownership(store_id: str):
    async def dependency(
        current_user: dict = Depends(get_current_user),
        pool: asyncpg.Pool = Depends(get_db_pool)
    ):
        async with pool.acquire() as conn:
            store = await conn.fetchrow(
                "SELECT id FROM kaspi_stores WHERE id = $1 AND user_id = $2",
                uuid.UUID(store_id), current_user['id']
            )
            if not store:
                raise HTTPException(404, detail="Store not found")
        return current_user
    return Depends(dependency)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
@router.get("/stores/{store_id}/products")
async def get_products(
    store_id: str,
    current_user: Annotated[dict, require_store_ownership(store_id)],
    # ...
):
    # Ownership —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω –≤ dependency
```

#### üí° Audit logging

**–î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É:**
```sql
CREATE TABLE audit_log (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    action TEXT,  -- "demping_run", "api_token_update", etc.
    resource_type TEXT,  -- "store", "product", etc.
    resource_id UUID,
    ip_address INET,
    created_at TIMESTAMP DEFAULT NOW()
);
```

**–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
- API token updates
- Store connect/disconnect
- Demping runs
- WhatsApp broadcasts

#### üí° Rate limiting per endpoint

**–°–µ–π—á–∞—Å:** Rate limiting —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API (Kaspi)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å user-level rate limiting –¥–ª—è –¥–æ—Ä–æ–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:
- AI endpoints (Gemini calls)
- WhatsApp broadcasts
- PDF merge

### 3. –†–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º

#### –ß—Ç–æ –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

| –§—É–Ω–∫—Ü–∏—è | –¢–µ–∫—É—â–∏–π –¥–æ—Å—Ç—É–ø | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|---------|----------------|--------------|
| **Niche Search** | –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ | Free: 10 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å, Paid: unlimited |
| **AI Lawyer** | –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ | Free: 5 –≤–æ–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å, Paid: unlimited |
| **Unit Economics** | –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ | Free: 3 —Ä–∞—Å—á—ë—Ç–∞/–¥–µ–Ω—å, Paid: unlimited |
| **Invoice Merge** | –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ | Free: 2 —Ñ–∞–π–ª–∞ max, Paid: unlimited |
| **Orders Export** | –ù–µ—Ç endpoint | –°–æ–∑–¥–∞—Ç—å —Å feature gate |
| **Analytics Export** | –ù–µ—Ç endpoint | –°–æ–∑–¥–∞—Ç—å —Å feature gate (CSV/Excel) |

### 4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

#### PII (Personally Identifiable Information)

**–ó–∞—â–∏—â—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- `users.email` ‚Äî owner only
- `users.phone` ‚Äî owner only
- `customer_contacts.phone` ‚Äî store owner only
- `orders.customer` ‚Äî store owner only

**‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ:** –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å PII —á—É–∂–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ API responses

#### API Tokens

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `kaspi_stores.api_key` ‚Äî plain text –≤ –ë–î
- `api_key_masked` –≤ responses ‚Äî –ø–µ—Ä–≤—ã–µ 4 + –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–∏–º–≤–æ–ª–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API keys –≤ –ë–î —á–µ—Ä–µ–∑ `ENCRYPTION_KEY`
- Separate read/write permissions (—Ç–æ–ª—å–∫–æ owner –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å/–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å)

### 5. Multi-tenancy considerations

#### –ï—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è B2B (–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ —É–ø—Ä–∞–≤–ª—è—é—Ç –º–∞–≥–∞–∑–∏–Ω–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤)

**–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
1. **Organizations** —Ç–∞–±–ª–∏—Ü–∞
2. **Team members** —Å —Ä–æ–ª—è–º–∏ (owner, manager, analyst)
3. **Permissions** per member (read_only, can_edit, can_demping)
4. **Separate billing** per organization vs per user

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
Organization
  ‚îî‚îÄ Team Members (users + roles)
      ‚îî‚îÄ Kaspi Stores (organization-owned)
          ‚îî‚îÄ Products, Orders, etc.
```

---

## üìä –ú–∞—Ç—Ä–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–∞ (Quick Reference)

| Module | Free | Basic | Standard | Premium | Admin |
|--------|------|-------|----------|---------|-------|
| Auth | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Billing | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Support | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Notifications | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Analytics** | ‚ùå | ‚úÖ (500) | ‚úÖ (1000) | ‚úÖ (unlim) | ‚úÖ |
| **Demping** | ‚ùå | ‚úÖ (50) | ‚úÖ (100) | ‚úÖ (200) | ‚úÖ |
| **AI Lawyer** | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Orders View** | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Invoice Glue** | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Unit Economics** | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Niche Search** | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| **City Demping** | ‚ùå (+addon) | ‚ùå (+addon) | ‚úÖ | ‚úÖ | ‚úÖ |
| **Preorder** | ‚ùå (+addon) | ‚ùå (+addon) | ‚úÖ | ‚úÖ | ‚úÖ |
| **WhatsApp Auto** | ‚ùå (+addon) | ‚ùå (+addon) | ‚úÖ | ‚úÖ | ‚úÖ |
| **Delivery Demping** | ‚ùå (+addon) | ‚ùå (+addon) | ‚ùå (+addon) | ‚úÖ | ‚úÖ |
| **Priority Products** | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |
| **WhatsApp Bulk** | ‚ùå (+addon) | ‚ùå (+addon) | ‚ùå (+addon) | ‚úÖ | ‚úÖ |
| **AI Salesman** | ‚ùå (+addon) | ‚ùå (+addon) | ‚ùå (+addon) | ‚ùå (+addon) | ‚úÖ |

**–õ–µ–≥–µ–Ω–¥–∞:**
- ‚úÖ = –î–æ—Å—Ç—É–ø–Ω–æ (feature gate: `require_feature()`)
- ‚ùå = –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ
- (+addon) = –î–æ—Å—Ç—É–ø–Ω–æ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∞–¥–¥–æ–Ω–∞

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### High Priority

1. **~~–î–æ–±–∞–≤–∏—Ç—å feature gates~~** ‚úÖ –°–¥–µ–ª–∞–Ω–æ (2026-02-15): –≤—Å–µ —Ä–æ—É—Ç–µ—Ä—ã –∑–∞–∫—Ä—ã—Ç—ã `require_feature()`

2. **Kaspi Store ownership:**
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–¥ INSERT –≤ `connect_store()`
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å multiple accounts –Ω–∞ –æ–¥–∏–Ω merchant_id

3. **API Keys encryption:**
   - –®–∏—Ñ—Ä–æ–≤–∞—Ç—å `kaspi_stores.api_key` –≤ –ë–î
   - –î–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏

### Medium Priority

4. **Centralized ownership checks:**
   - –°–æ–∑–¥–∞—Ç—å `require_store_ownership()` dependency
   - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≤—Å–µ—Ö endpoints –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

5. **Audit logging:**
   - –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `audit_log`
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

6. **Rate limiting:**
   - Per-user rate limits –¥–ª—è AI endpoints
   - Per-user rate limits –¥–ª—è expensive operations

### Low Priority

7. **~~Niche Search feature gate~~** ‚úÖ –°–¥–µ–ª–∞–Ω–æ: `require_feature("niche_search")`, Standard+ –ø–ª–∞–Ω—ã

8. **Analytics/Orders export:**
   - –ù–æ–≤—ã–µ endpoints —Å feature gates
   - CSV/Excel export

9. **B2B multi-tenancy:**
   - Organizations model
   - Team permissions

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-02-15
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 2.0 (feature gates fix, prices/limits updated)
