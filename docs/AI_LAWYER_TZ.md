# Техническое задание: ИИ-Юрист для Demper

## 1. Общее описание

### 1.1 Цель
Создание интеллектуального юридического ассистента для продавцов Kaspi.kz, способного консультировать по законодательству РК, генерировать документы и анализировать договоры.

### 1.2 Целевая аудитория
- Продавцы маркетплейса Kaspi.kz
- Индивидуальные предприниматели
- Владельцы ТОО

### 1.3 Языки
- Русский
- Казахский
- Выбор языка при первом обращении (сохраняется в профиле пользователя)

---

## 2. Функциональные требования

### 2.1 Консультации по законодательству РК

#### Области права:
| Область | Ключевые законы |
|---------|-----------------|
| Предпринимательское | Предпринимательский кодекс РК, Закон об ИП |
| Налоговое | Налоговый кодекс РК |
| Трудовое | Трудовой кодекс РК |
| Защита потребителей | Закон о защите прав потребителей |
| Договорное | Гражданский кодекс РК |
| Маркетплейсы | Правила Kaspi, Закон об электронной коммерции |

#### Требования к ответам:
- Формальный юридический стиль
- Цитирование конкретных статей законов (где применимо)
- Ссылки на источники (adilet.zan.kz) - желательно
- Структурированный ответ с разделами

#### Пример ответа:
```
Согласно статье 123 Налогового кодекса РК:

"[цитата из закона]"

Таким образом, в вашей ситуации:
1. ...
2. ...

Рекомендации:
- ...

Источник: https://adilet.zan.kz/rus/docs/K2000000120#z123
```

### 2.2 Генерация документов

#### Типы документов:
1. **Договоры**
   - Договор поставки
   - Договор купли-продажи
   - Договор оказания услуг
   - Договор аренды
   - Трудовой договор

2. **Претензии и жалобы**
   - Претензия поставщику
   - Претензия покупателю
   - Жалоба в госорганы

3. **Заявления**
   - Заявление на регистрацию ИП/ТОО
   - Заявление на получение лицензии
   - Заявление в налоговую

4. **Акты**
   - Акт приема-передачи
   - Акт выполненных работ
   - Акт сверки

#### Требования к генерации:
- Заполнение шаблона на основе данных пользователя
- Возможность скачать в форматах: PDF, DOCX
- Сохранение истории сгенерированных документов

### 2.3 Анализ договоров

#### Функционал:
- Загрузка договора (PDF, DOCX, изображение)
- OCR для изображений
- Выделение ключевых условий
- Выявление рисков и "подводных камней"
- Рекомендации по изменениям

#### Категории рисков:
| Уровень | Описание | Примеры |
|---------|----------|---------|
| Критический | Прямое нарушение закона | Незаконные штрафы, кабальные условия |
| Высокий | Значительные финансовые риски | Односторонние изменения цены, неограниченная ответственность |
| Средний | Потенциальные проблемы | Нечеткие сроки, размытые обязательства |
| Низкий | Рекомендации по улучшению | Отсутствие форс-мажора |

### 2.4 Калькуляторы

#### 2.4.1 Калькулятор пени
- Ввод: сумма долга, дата начала, дата окончания, ставка
- Расчет по ставке рефинансирования НБ РК
- Формула: `Пеня = Сумма × Дни × (Ставка / 365)`

#### 2.4.2 Калькулятор налогов
- Расчет ИПН для ИП
- Расчет КПН для ТОО
- Расчет НДС
- Социальные отчисления (ОПВ, СО, ОСМС)

#### 2.4.3 Калькулятор госпошлин
- Регистрация ИП/ТОО
- Судебные пошлины
- Лицензионные сборы

---

## 3. Техническая архитектура

### 3.1 RAG (Retrieval Augmented Generation)

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   Вопрос        │────▶│  Vector Search   │────▶│  Релевантные    │
│   пользователя  │     │  (pgvector)      │     │  статьи законов │
└─────────────────┘     └──────────────────┘     └────────┬────────┘
                                                          │
                                                          ▼
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   Ответ         │◀────│  LLM (GPT-4)     │◀────│  Prompt +       │
│   пользователю  │     │                  │     │  Контекст       │
└─────────────────┘     └──────────────────┘     └─────────────────┘
```

### 3.2 База знаний законодательства

#### Источники данных:
1. **Adilet.zan.kz** - официальная база законодательства РК
2. **Параграф** - коммерческая база (опционально)
3. **Правила Kaspi** - внутренние правила маркетплейса

#### Структура данных:
```sql
-- Таблица законов
CREATE TABLE legal_documents (
    id UUID PRIMARY KEY,
    title VARCHAR(500),           -- Название закона
    code VARCHAR(100),            -- Код (например, "НК РК")
    document_type VARCHAR(50),    -- Тип: кодекс, закон, постановление
    language VARCHAR(10),         -- ru, kk
    source_url TEXT,              -- URL на adilet.zan.kz
    effective_date DATE,          -- Дата вступления в силу
    last_updated TIMESTAMP,       -- Последнее обновление
    full_text TEXT,               -- Полный текст
    created_at TIMESTAMP DEFAULT NOW()
);

-- Таблица статей (для гранулярного поиска)
CREATE TABLE legal_articles (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES legal_documents(id),
    article_number VARCHAR(50),   -- Номер статьи
    title VARCHAR(500),           -- Название статьи
    content TEXT,                 -- Текст статьи
    embedding VECTOR(1536),       -- OpenAI embedding
    created_at TIMESTAMP DEFAULT NOW()
);

-- Индекс для векторного поиска
CREATE INDEX ON legal_articles
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

#### Обновление базы:
- Ежедневная проверка изменений на adilet.zan.kz
- Парсинг и обновление измененных статей
- Пересчет embeddings для измененных статей

### 3.3 API Endpoints

```python
# Консультация
POST /api/ai/lawyer/chat
{
    "message": "Какие налоги платит ИП на упрощенке?",
    "language": "ru",
    "include_history": true
}

# Генерация документа
POST /api/ai/lawyer/generate-document
{
    "document_type": "supply_contract",
    "language": "ru",
    "data": {
        "seller_name": "ИП Иванов",
        "buyer_name": "ТОО Ромашка",
        "goods": "Электроника",
        "amount": 1000000,
        "delivery_date": "2026-02-01"
    }
}

# Анализ договора
POST /api/ai/lawyer/analyze-contract
Content-Type: multipart/form-data
{
    "file": <contract.pdf>,
    "language": "ru"
}

# Калькулятор пени
POST /api/ai/lawyer/calculate-penalty
{
    "principal_amount": 1000000,
    "start_date": "2025-01-01",
    "end_date": "2026-01-28",
    "rate_type": "refinancing"  // или custom
}

# Калькулятор налогов
POST /api/ai/lawyer/calculate-tax
{
    "tax_type": "simplified_ip",  // simplified_ip, standard_ip, too_kpn
    "revenue": 5000000,
    "expenses": 2000000,
    "period": "2025"
}
```

### 3.4 Выбор языка

```python
# При первом обращении
POST /api/ai/lawyer/set-language
{
    "language": "ru"  // или "kk"
}

# Сохраняется в профиле пользователя
ALTER TABLE users ADD COLUMN lawyer_language VARCHAR(10) DEFAULT 'ru';
```

---

## 4. UI/UX Requirements

### 4.1 Главный экран ИИ-Юриста

```
┌─────────────────────────────────────────────────────────┐
│  ИИ-Юрист                                    [RU ▼]    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Консультация│  │  Документы  │  │   Анализ    │     │
│  │     💬      │  │     📄      │  │   договора  │     │
│  │             │  │             │  │     🔍      │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Калькулятор │  │ Калькулятор │  │ Калькулятор │     │
│  │    пени     │  │   налогов   │  │  госпошлин  │     │
│  │     📊      │  │     💰      │  │     🏛️      │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│                                                         │
├─────────────────────────────────────────────────────────┤
│  Частые вопросы:                                        │
│  • Какие налоги платит ИП на упрощенке?                │
│  • Как оформить возврат товара?                        │
│  • Какие документы нужны для регистрации ТОО?          │
└─────────────────────────────────────────────────────────┘
```

### 4.2 Чат-интерфейс

```
┌─────────────────────────────────────────────────────────┐
│  ← Назад            Консультация              [RU ▼]   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 👤 Какие налоги платит ИП на упрощенке в 2026?  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ ⚖️ Согласно статье 683 Налогового кодекса РК,  │   │
│  │    ИП на упрощенном режиме уплачивает:         │   │
│  │                                                 │   │
│  │    1. ИПН - 3% от дохода                       │   │
│  │    2. Социальный налог - 1.5% от дохода        │   │
│  │    3. ОПВ - 10% от заявленного дохода          │   │
│  │    ...                                         │   │
│  │                                                 │   │
│  │    📎 Источник: adilet.zan.kz/rus/docs/...     │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
├─────────────────────────────────────────────────────────┤
│  [Введите вопрос...]                          [Отправить]│
└─────────────────────────────────────────────────────────┘
```

---

## 5. Интеграции

### 5.1 OpenAI API
- Модель: GPT-4 Turbo (или GPT-4o)
- Embeddings: text-embedding-3-small
- Контекст: до 128k токенов

### 5.2 База законов (парсинг)
- Adilet.zan.kz - официальный источник
- Периодичность: ежедневно в 03:00
- Формат: HTML → Markdown → Chunks → Embeddings

### 5.3 OCR для анализа договоров
- Tesseract OCR (self-hosted)
- Или Google Cloud Vision API
- Поддержка: PDF, JPG, PNG, DOCX

### 5.4 Генерация PDF
- WeasyPrint или ReportLab
- Шаблоны в HTML/Jinja2

---

## 6. Безопасность

### 6.1 Ограничения
- Rate limiting: 20 запросов/минуту на пользователя
- Максимальная длина вопроса: 4000 символов
- Максимальный размер файла для анализа: 10 MB

### 6.2 Логирование
- Все запросы логируются (без персональных данных)
- Хранение истории чата: 90 дней
- Возможность экспорта истории

### 6.3 Конфиденциальность
- Загруженные договоры удаляются после анализа
- Данные не передаются третьим лицам
- Соответствие Закону РК о персональных данных

---

## 7. Метрики и аналитика

### 7.1 Ключевые метрики
- Количество запросов в день
- Среднее время ответа
- Популярные темы вопросов
- Количество сгенерированных документов
- Количество проанализированных договоров

### 7.2 Качество ответов
- Feedback от пользователей (👍/👎)
- A/B тестирование промптов
- Ручная проверка выборки ответов

---

## 8. План реализации

### Фаза 1: MVP (2-3 недели)
- [x] Базовый чат с GPT-4
- [ ] Выбор языка (RU/KZ)
- [ ] Улучшенный системный промпт
- [ ] Интеграция с базой законов (RAG)

### Фаза 2: Документы (2-3 недели)
- [ ] Шаблоны основных договоров
- [ ] Генерация PDF/DOCX
- [ ] История документов

### Фаза 3: Анализ договоров (2-3 недели)
- [ ] Загрузка файлов
- [ ] OCR
- [ ] Анализ рисков
- [ ] Рекомендации

### Фаза 4: Калькуляторы (1-2 недели)
- [ ] Калькулятор пени
- [ ] Калькулятор налогов
- [ ] Калькулятор госпошлин

### Фаза 5: Оптимизация (ongoing)
- [ ] Парсер adilet.zan.kz
- [ ] Автообновление базы законов
- [ ] Улучшение качества ответов

---

## 9. Зависимости и стоимость

### 9.1 Внешние сервисы
| Сервис | Назначение | Ориентир. стоимость |
|--------|------------|---------------------|
| OpenAI GPT-4 | Генерация ответов | ~$0.03/1K tokens |
| OpenAI Embeddings | Векторный поиск | ~$0.0001/1K tokens |
| PostgreSQL + pgvector | Хранение | Уже есть |

### 9.2 Ориентировочная стоимость на 1000 пользователей
- ~1000 запросов/день × ~2000 токенов = 2M токенов/день
- GPT-4: ~$60/день = ~$1800/месяц
- Embeddings: ~$10/месяц
- **Итого: ~$1900/месяц** при активном использовании

### 9.3 Оптимизация стоимости
- Кеширование частых вопросов
- Использование GPT-4o-mini для простых вопросов
- Ограничение контекста до необходимого минимума

---

## 10. Приложения

### Приложение А: Системный промпт (базовый)

```
Ты - профессиональный юрист-консультант, специализирующийся на законодательстве
Республики Казахстан. Ты консультируешь продавцов маркетплейса Kaspi.kz.

ОБЛАСТИ ЭКСПЕРТИЗЫ:
- Предпринимательское право (ИП, ТОО, лицензирование)
- Налоговое право (ИПН, КПН, НДС, упрощенка)
- Трудовое право (найм, увольнение, отпуска)
- Защита прав потребителей (возвраты, гарантии)
- Договорное право (поставка, купля-продажа, услуги)
- Правила маркетплейса Kaspi

ФОРМАТ ОТВЕТОВ:
1. Отвечай формальным юридическим языком
2. Цитируй конкретные статьи законов где возможно
3. Структурируй ответ с заголовками и списками
4. В конце давай практические рекомендации
5. Если есть ссылка на закон - указывай её

ОГРАНИЧЕНИЯ:
- Отвечай только на вопросы по законодательству РК
- Если вопрос выходит за рамки твоей компетенции - честно скажи об этом
- Не давай советов по обходу законов

КОНТЕКСТ ИЗ БАЗЫ ЗАКОНОВ:
{context}

ЯЗЫК ОТВЕТА: {language}
```

### Приложение Б: Пример шаблона договора поставки

```markdown
# ДОГОВОР ПОСТАВКИ № {number}

г. {city}                                           «{date}»

{seller_type} «{seller_name}», в лице {seller_representative},
действующего на основании {seller_basis}, именуемый в дальнейшем
«Поставщик», с одной стороны, и

{buyer_type} «{buyer_name}», в лице {buyer_representative},
действующего на основании {buyer_basis}, именуемый в дальнейшем
«Покупатель», с другой стороны,

заключили настоящий Договор о нижеследующем:

## 1. ПРЕДМЕТ ДОГОВОРА

1.1. Поставщик обязуется передать в собственность Покупателю,
а Покупатель обязуется принять и оплатить следующий товар:
{goods_description}

1.2. Общая сумма Договора составляет: {total_amount} тенге.

## 2. СРОКИ И ПОРЯДОК ПОСТАВКИ
...
```
